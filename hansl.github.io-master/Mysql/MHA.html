<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="referrer" content="origin" />
<title>MySQL高可用之MHA的搭建 - GoogSQL - 博客园</title>
<meta property="og:description" content="MySQL MHA架构介绍：MHA（MasterHigh Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebo" />
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=-duj5vpGTntb85GJoM3iRI972XwWcI-j8zmqDzyfu2w1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/ThinkInside/bundle-ThinkInside.css?v=RRjf6pEarGnbXZ86qxNycPfQivwSKWRa4heYLB15rVE1"/>
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="/skins/ThinkInside/bundle-ThinkInside-mobile.css?v=ihRo9gBDj79xhIj6_krWkLjmE30L09NDwbtr0-05i081"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/xuanzhi201111/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/xuanzhi201111/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/xuanzhi201111/wlwmanifest.xml"/>
<script src="//common.cnblogs.com/scripts/jquery-2.2.0.min.js"></script>
<script type="text/javascript">var currentBlogApp = 'xuanzhi201111', cb_enable_mathjax=false;var isLogined=false;</script>
<script src="/bundles/blog-common.js?v=ZWIrkNiD09PHa1ulf9ZyvZWj5tgvjISWcwFqcBtd1BY1" type="text/javascript"></script>
</head>
<body>


<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/xuanzhi201111/p/4231412.html">MySQL高可用之MHA的搭建</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body"><p>&nbsp;<strong>MySQL MHA架构</strong><strong>介绍：</strong></p>
<p>MHA（Master&nbsp;High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p>
<p><strong>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）</strong>。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<p>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据的不丢失，但这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。</p>
<p>目前MHA主要支持一主多从的架构，<strong>要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，</strong>一主二从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器，出于机器成本的考虑，淘宝也在该基础上进行了改造，目前淘宝TMHA已经支持一主一从。（出自：《深入浅出MySQL(第二版)》）</p>
<p>架构图：</p>
<p><img src="https://images0.cnblogs.com/blog/645933/201501/210927511725309.png" alt="" /></p>
<p><strong>MHA工作原理总结为以下几条：</strong></p>
<p><strong>（1）从宕机崩溃的master保存二进制日志事件（binlog events）;</strong></p>
<p><strong>（2）识别含有最新更新的slave;</strong></p>
<p><strong>（3）应用差异的中继日志(relay log) 到其他slave;</strong></p>
<p><strong>（4）应用从master保存的二进制日志事件(binlog events);</strong></p>
<p><strong>（5）提升一个slave为新master;</strong></p>
<p><strong>（6）使用其他的slave连接新的master进行复制。</strong></p>
<p>&nbsp;</p>
<p>&nbsp;官方介绍：<a href="https://code.google.com/p/mysql-master-ha/">https://code.google.com/p/mysql-master-ha/</a></p>
<p>&nbsp;</p>
<p>实验环境：(centos6.2 MySQL版本5.5)</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">角色                  ip地址          主机名          server_id                  类型
Monitor host        </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span>     server01            -<span style="color: #000000;">                   监控复制组
Master              </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>     server02            <span style="color: #800080;">1</span><span style="color: #000000;">                    写入
Candicate master    </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>     server03            <span style="color: #800080;">2</span><span style="color: #000000;">                    读
Slave               </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>     server04            <span style="color: #800080;">3</span>                    读</pre>
</div>
<p>server03和server04是server02的slave，复制环境搭建后面会简单演示,其中master对外提供写服务，备选master（实际的slave，主机名server03）提供读服务，slave也提供相关的读服务，一旦master宕机，将会把备选master提升为新的master，slave指向新的master</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>1、部署<strong>MHA</strong>过程：</p>
<p>方法一</p>
<p>在<span style="color: #0000ff;">所有节点</span>都要安装MHA node所需的perl模块（DBD:mysql），可以通过yum安装，如果没epel源,先安装epel源，在如下：（<span style="color: #0000ff;">温馨提示：系统时间一定要是最新的，否则安装时会出各种奇葩问题</span>）</p>
<p><strong>在server02(192.168.2.128)操作：</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ rpm -ivh http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
Retrieving http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
warning: /var/tmp/rpm-tmp.SAbcKl: Header V3 RSA/<span style="color: #000000;">SHA256 Signature, key ID 0608b895: NOKEY
Preparing...                ########################################### [</span><span style="color: #800080;">100</span>%<span style="color: #000000;">]
   </span><span style="color: #800080;">1</span>:epel-release           ########################################### [<span style="color: #800080;">100</span>%<span style="color: #000000;">]
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> <span style="color: #0000ff;">perl</span>-DBD-MySQL -y</pre>
</div>
<p>&nbsp;<strong>在server03(192.168.2.129)操作：</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ rpm -ivh http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
Retrieving http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
warning: /var/tmp/rpm-tmp.gsdYwg: Header V3 RSA/<span style="color: #000000;">SHA256 Signature, key ID 0608b895: NOKEY
Preparing...                ########################################### [</span><span style="color: #800080;">100</span>%<span style="color: #000000;">]
   </span><span style="color: #800080;">1</span>:epel-release           ########################################### [<span style="color: #800080;">100</span>%<span style="color: #000000;">]
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> <span style="color: #0000ff;">perl</span>-DBD-MySQL -y</pre>
</div>
<p>&nbsp;<strong>在server04(192.168.2.130)操作：</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ rpm -ivh http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
Retrieving http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
warning: /var/tmp/rpm-tmp.TUeiym: Header V3 RSA/<span style="color: #000000;">SHA256 Signature, key ID 0608b895: NOKEY
Preparing...                ########################################### [</span><span style="color: #800080;">100</span>%<span style="color: #000000;">]
   </span><span style="color: #800080;">1</span>:epel-release           ########################################### [<span style="color: #800080;">100</span>%<span style="color: #000000;">]
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> <span style="color: #0000ff;">perl</span>-DBD-MySQL -y</pre>
</div>
<p>（2）在所有的节点安装MHA node：（<span style="color: #0000ff;">下面以server02为例，记得server03和server04也一样的操作</span>），MHA node和MHA&nbsp;Manager都在要官网下载，</p>
<p>下载地址：https://code.google.com/p/mysql-master-ha/wiki/Downloads?tm=2（自备梯子）</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">tar</span> xf mha4mysql-node-<span style="color: #800080;">0.56</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ cd mha4mysql-node-<span style="color: #800080;">0.56</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL
Can</span><span style="color: #800000;">'</span><span style="color: #800000;">t locate ExtUtils/MakeMaker.pm in @INC (@INC contains: inc /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) at inc/Module/Install/Makefile.pm line 4.</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> -y <span style="color: #0000ff;">perl</span>-<span style="color: #000000;">devel
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL          
</span>*** Module::AutoInstall version <span style="color: #800080;">1.03</span>
*** Checking <span style="color: #0000ff;">for</span><span style="color: #000000;"> Perl dependencies...
Can</span><span style="color: #800000;">'</span><span style="color: #800000;">t locate CPAN.pm in @INC (@INC contains: inc /usr/local/lib64/perl5 /usr/local/share/perl5 /usr/lib64/perl5/vendor_perl /usr/share/perl5/vendor_perl /usr/lib64/perl5 /usr/share/perl5 .) at inc/Module/AutoInstall.pm line 279.</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> -y <span style="color: #0000ff;">perl</span>-<span style="color: #000000;">CPAN

</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL        
</span>*** Module::AutoInstall version <span style="color: #800080;">1.03</span>
*** Checking <span style="color: #0000ff;">for</span><span style="color: #000000;"> Perl dependencies...
[Core Features]
</span>- DBI        ...loaded. (<span style="color: #800080;">1.609</span><span style="color: #000000;">)
</span>- DBD::mysql ...loaded. (<span style="color: #800080;">4.013</span><span style="color: #000000;">)
</span>***<span style="color: #000000;"> Module::AutoInstall configuration finished.
Checking </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> your kit is complete...
Looks good
Writing Makefile </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> mha4mysql::node
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">make</span> &amp;&amp; <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span></pre>
</div>
<p>方法二、</p>
<p>安装MHA node所需的perl模块（DBD:mysql）也可以通过脚本安装，安装脚本如下：（<span style="color: #0000ff;">个人不建议用这样的方法安装，安装时间比较长，本人试过，蛋碎一地，太多问题了，要花时间去找资料，而且我们不能确定这些依赖带来的问题是否影响后面的使用</span>）</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">cat</span> <span style="color: #0000ff;">install</span>.<span style="color: #0000ff;">sh</span><span style="color: #000000;"> 
#</span>!/bin/<span style="color: #000000;">bash
</span><span style="color: #0000ff;">wget</span> http:<span style="color: #008000;">//</span><span style="color: #008000;">xrl.us/cpanm --no-check-certificate</span>
<span style="color: #0000ff;">mv</span> cpanm /usr/<span style="color: #000000;">bin
</span><span style="color: #0000ff;">chmod</span> <span style="color: #800080;">755</span> /usr/bin/<span style="color: #000000;">cpanm
</span><span style="color: #0000ff;">cat</span> &gt; /root/list &lt;&lt;<span style="color: #000000;"> EOF
</span><span style="color: #0000ff;">install</span><span style="color: #000000;"> DBD::mysql
EOF
</span><span style="color: #0000ff;">for</span> package <span style="color: #0000ff;">in</span> `<span style="color: #0000ff;">cat</span> /root/<span style="color: #000000;">list`
</span><span style="color: #0000ff;">do</span><span style="color: #000000;">
    cpanm $package
</span><span style="color: #0000ff;">done</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$</pre>
</div>
<p>再安装MHA node节点：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">tar</span> xf mha4mysql-node-<span style="color: #800080;">0.56</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ cd mha4mysql-node-<span style="color: #800080;">0.56</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">make</span> &amp;&amp; <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span></pre>
</div>
<p>安装完成后会在/usr/local/bin目录下生成以下脚本文件：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ cd /usr/local/bin/
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root bin]$ <span style="color: #0000ff;">pwd</span>
/usr/local/<span style="color: #000000;">bin
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> [root bin]$ ll
总用量 </span><span style="color: #800080;">40576</span>
-r-xr-xr-x  <span style="color: #800080;">1</span> root root    <span style="color: #800080;">15498</span> 1月  <span style="color: #800080;">18</span> <span style="color: #800080;">11</span>:<span style="color: #800080;">02</span><span style="color: #000000;"> apply_diff_relay_logs
</span>-r-xr-xr-x  <span style="color: #800080;">1</span> root root     <span style="color: #800080;">4807</span> 1月  <span style="color: #800080;">18</span> <span style="color: #800080;">11</span>:<span style="color: #800080;">02</span><span style="color: #000000;"> filter_mysqlbinlog
</span>-r-xr-xr-x  <span style="color: #800080;">1</span> root root     <span style="color: #800080;">7401</span> 1月  <span style="color: #800080;">18</span> <span style="color: #800080;">11</span>:<span style="color: #800080;">02</span><span style="color: #000000;"> purge_relay_logs
</span>-r-xr-xr-x  <span style="color: #800080;">1</span> root root     <span style="color: #800080;">7263</span> 1月  <span style="color: #800080;">18</span> <span style="color: #800080;">11</span>:<span style="color: #800080;">02</span><span style="color: #000000;"> save_binary_logs
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root bin]$</pre>
</div>
<p>Node脚本说明：(这些工具通常由MHA Manager的脚本触发，无需人为操作)</p>
<div class="cnblogs_code">
<pre>save_binary_logs               <span style="color: #008000;">//</span><span style="color: #008000;">保存和复制master的二进制日志</span>
apply_diff_relay_logs          <span style="color: #008000;">//</span><span style="color: #008000;">识别差异的中继日志事件并将其差异的事件应用于其他的slave</span>
filter_mysqlbinlog             <span style="color: #008000;">//</span><span style="color: #008000;">去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span>
purge_relay_logs               <span style="color: #008000;">//</span><span style="color: #008000;">清除中继日志（不会阻塞SQL线程）</span></pre>
</div>
<p>&nbsp;</p>
<p><strong>2.安装MHA Manager,在MHA Manager的主机也是需要安装MHA Node,MHA Manger也依赖于perl模块</strong></p>
<p>（1）在MHA Manager的主机也是需要安装MHA Node,所以以下的步骤和上面的操作一样，如下（<span style="color: #0000ff;">在server01 192.168.2.131操作</span>）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ rpm -ivh http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
Retrieving http:<span style="color: #008000;">//</span><span style="color: #008000;">dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
Preparing...                ########################################### [<span style="color: #800080;">100</span>%<span style="color: #000000;">]
        package epel</span>-release-<span style="color: #800080;">6</span>-<span style="color: #800080;">8</span><span style="color: #000000;">.noarch is already installed
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> <span style="color: #0000ff;">perl</span>-DBD-MySQL -<span style="color: #000000;">y</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> -y <span style="color: #0000ff;">perl</span>-devel <span style="color: #0000ff;">perl</span>-<span style="color: #000000;">CPAN
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">tar</span> xf mha4mysql-node-<span style="color: #800080;">0.56</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ cd mha4mysql-node-<span style="color: #800080;">0.56</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">make</span> &amp;&amp; <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span></pre>
</div>
<p>（2）安装MHA Manager。首先安装MHA Manger依赖的perl模块（我这里使用yum安装）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> <span style="color: #0000ff;">perl</span>-DBD-MySQL <span style="color: #0000ff;">perl</span>-Config-Tiny <span style="color: #0000ff;">perl</span>-Log-Dispatch <span style="color: #0000ff;">perl</span>-Parallel-ForkManager <span style="color: #0000ff;">perl</span>-Time-HiRes -y</pre>
</div>
<p>安装MHA Manager软件包：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-node-<span style="color: #800080;">0.56</span><span style="color: #000000;">]$ cd</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">tar</span> xf mha4mysql-manager-<span style="color: #800080;">0.56</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ cd mha4mysql-manager-<span style="color: #800080;">0.56</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-manager-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">perl</span><span style="color: #000000;"> Makefile.PL
</span>*** Module::AutoInstall version <span style="color: #800080;">1.03</span>
*** Checking <span style="color: #0000ff;">for</span><span style="color: #000000;"> Perl dependencies...
[Core Features]
</span>- DBI                   ...loaded. (<span style="color: #800080;">1.609</span><span style="color: #000000;">)
</span>- DBD::mysql            ...loaded. (<span style="color: #800080;">4.013</span><span style="color: #000000;">)
</span>- Time::HiRes           ...loaded. (<span style="color: #800080;">1.9721</span><span style="color: #000000;">)
</span>- Config::Tiny          ...loaded. (<span style="color: #800080;">2.12</span><span style="color: #000000;">)
</span>- Log::Dispatch         ...loaded. (<span style="color: #800080;">2.26</span><span style="color: #000000;">)
</span>- Parallel::ForkManager ...loaded. (<span style="color: #800080;">0.7</span>.<span style="color: #800080;">9</span><span style="color: #000000;">)
</span>- MHA::NodeConst        ...loaded. (<span style="color: #800080;">0.56</span><span style="color: #000000;">)
</span>***<span style="color: #000000;"> Module::AutoInstall configuration finished.
Writing Makefile </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> mha4mysql::manager
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root mha4mysql-manager-<span style="color: #800080;">0.56</span>]$ <span style="color: #0000ff;">make</span> &amp;&amp; <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span></pre>
</div>
<p>安装完成后，在/usr/local/bin会产生相关的脚本：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ <span style="color: #0000ff;">pwd</span>
/usr/local/<span style="color: #000000;">bin
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span><span style="color: #000000;"> [root bin]$ ll
总用量 </span><span style="color: #800080;">37364</span>
-r-xr-xr-x. <span style="color: #800080;">1</span> root root    <span style="color: #800080;">15498</span> 1月  <span style="color: #800080;">11 <span style="color: #800080;">22:<span style="color: #800080;">55</span></span></span><span style="color: #000000;"> apply_diff_relay_logs
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">4807</span> 1月  <span style="color: #800080;">11 <span style="color: #800080;">22:<span style="color: #800080;">55</span></span></span><span style="color: #000000;"> filter_mysqlbinlog
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">1995</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_check_repl
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">1779</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_check_ssh
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">1865</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_check_status
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">3201</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_conf_host
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">2517</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_manager
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">2165</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_master_monitor
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">2373</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_master_switch
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">3749</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_secondary_check
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">1739</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22</span>:<span style="color: #800080;">55</span><span style="color: #000000;"> masterha_stop
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">7401</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22:<span style="color: #800080;">55</span></span><span style="color: #000000;"> purge_relay_logs
</span>-r-xr-xr-x. <span style="color: #800080;">1</span> root root     <span style="color: #800080;">7263</span> 1月  <span style="color: #800080;">11</span> <span style="color: #800080;">22:<span style="color: #800080;">55</span></span><span style="color: #000000;"> save_binary_logd</span></pre>
</div>
<p>复制相关脚本到/usr/local/bin目录(<span style="color: #0000ff;">软件包解压缩后就有了，不是必须，因为这些脚本不完整，需要自己修改，这是软件开发着留给我们自己发挥的,如果开启下面的任何一个脚本对应的参数，而对应这里的脚本又没有修改，则会抛错，自己被坑的很惨</span>)</p>
<div class="cnblogs_code">
<pre>192.168.2.131<span style="color: #000000;"> [root scripts]$ pwd
</span>/root/mha4mysql-manager-0.56/samples/<span style="color: #000000;">scripts
</span>192.168.2.131<span style="color: #000000;"> [root scripts]$ ll
总用量 </span>32
-rwxr-xr-x. 1 root root  3443 1月   8 2012 master_ip_failover  <span style="color: #008000;">//</span><span style="color: #008000;">自动切换时vip管理的脚本，不是必须，如果我们使用keepalived的，我们可以自己编写脚本完成对vip的管理，比如监控mysql，如果mysql异常，                                                               我们停止keepalived就行，这样vip就会自动漂移</span>
-rwxr-xr-x. 1 root root  9186 1月   8 2012 master_ip_online_change  <span style="color: #008000;">//</span><span style="color: #008000;">在线切换时vip的管理，不是必须，同样可以可以自行编写简单的shell完成</span>
-rwxr-xr-x. 1 root root 11867 1月   8 2012 power_manager   <span style="color: #008000;">//</span><span style="color: #008000;">故障发生后关闭主机的脚本，不是必须</span>
-rwxr-xr-x. 1 root root  1360 1月   8 2012 send_report    <span style="color: #008000;">//</span><span style="color: #008000;">因故障切换后发送报警的脚本，不是必须，可自行编写简单的shell完成</span>
<br /> 192.168.2.131 [root scripts]$ cp * /usr/local/bin/</pre>
</div>
<p>&nbsp;</p>
<p>3.配置SSH登录无密码验证（<span style="color: #0000ff;">使用key登录，工作中常用，最好不要禁掉密码登录，如果禁了，可能会有问题</span>）</p>
<p>在server02 192.168.2.131操作（Monitor）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">t rsa
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span></pre>
</div>
<p>在server02 192.168.2.128操作（Master）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">t rsa
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span></pre>
</div>
<p>在server03 192.168.2.129操作(slave)：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">t rsa
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span></pre>
</div>
<p>在server04 192.168.2.130操作(slave)：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">ssh-keygen</span> -<span style="color: #000000;">t rsa
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">ssh</span>-copy-<span style="color: #0000ff;">id</span> -i /root/.<span style="color: #0000ff;">ssh</span>/id_rsa.pub root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span></pre>
</div>
<p>&nbsp;</p>
<p>4.搭建主从复制环境</p>
<p>注意：binlog-do-db 和 replicate-ignore-db 设置必须相同。 MHA 在启动时候会检测过滤规则，如果过滤规则不同，MHA 不启动监控和故障转移。</p>
<p>（1）在Master 192.168.2.128(server02)上备份一份完整的数据：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ mysqldump -uroot -p123456 --master-data=<span style="color: #800080;">2</span> --single-transaction -R --triggers -A &gt; all.sql</pre>
</div>
<p>其中<strong>--master-data=2</strong>代表备份时刻记录master的Binlog位置和Position，<strong>--single-transaction</strong>意思是获取一致性快照，<strong>-R</strong>意思是备份存储过程和函数，<strong>--triggres</strong>的意思是备份触发器，<strong>-A</strong>代表备份所有的库。更多信息请自行mysqldump --help查看。</p>
<p>（2）在Master 192.168.2.128(server02)上创建复制用户:</p>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span> <span style="color: #0000ff;">grant</span> <span style="color: #0000ff;">replication</span> slave <span style="color: #0000ff;">on</span> <span style="color: #808080;">*</span>.<span style="color: #808080;">*</span> <span style="color: #0000ff;">to</span> <span style="color: #ff0000;">'</span><span style="color: #ff0000;">repl</span><span style="color: #ff0000;">'</span>@<span style="color: #ff0000;">'</span><span style="color: #ff0000;">192.168.2.%</span><span style="color: #ff0000;">'</span> identified <span style="color: #0000ff;">by</span> <span style="color: #ff0000;">'</span><span style="color: #ff0000;">123456</span><span style="color: #ff0000;">'</span><span style="color: #000000;">; 
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span> flush <span style="color: #0000ff;">privileges</span><span style="color: #000000;">;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span> sec)</pre>
</div>
<p>（3）查看主库备份时的binlog名称和位置，MASTER_LOG_FILE和MASTER_LOG_POS：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">head</span> -n <span style="color: #800080;">30</span> all.sql | <span style="color: #0000ff;">grep</span> <span style="color: #800000;">'</span><span style="color: #800000;">CHANGE MASTER TO</span><span style="color: #800000;">'</span>
-- CHANGE MASTER TO MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000004</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">245</span>;</pre>
</div>
<p>（4）把备份复制到192.168.2.129和192.168.2.130</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">scp</span> all.sql <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:/root/<span style="color: #000000;">
all.sql                                                                                                                              </span><span style="color: #800080;">100</span>%  500KB <span style="color: #800080;">500</span>.5KB/s   <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>    
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">scp</span> all.sql <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:/root/<span style="color: #000000;">
all.sql                  </span></pre>
</div>
<p>（5）分别在两台服务器上导入备份，执行复制相关命令</p>
<p>在slave主机server03 192.168.2.129上操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ mysql -uroot -p123456 &lt; ./all.sql </pre>
</div>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span><span style="color: #000000;"> stop slave;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.01</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span>  CHANGE MASTER <span style="color: #0000ff;">TO</span> MASTER_HOST<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">192.168.2.128</span><span style="color: #ff0000;">'</span>,MASTER_USER<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">repl</span><span style="color: #ff0000;">'</span>, MASTER_PASSWORD<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">123456</span><span style="color: #ff0000;">'</span>,MASTER_LOG_FILE<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">mysql-bin.000004</span><span style="color: #ff0000;">'</span>,MASTER_LOG_POS<span style="color: #808080;">=</span><span style="color: #800000; font-weight: bold;">245</span><span style="color: #000000;">; 
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.01</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span><span style="color: #000000;"> start slave;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span><span style="color: #000000;"> show slave status\G
</span><span style="color: #808080;">***************************</span> <span style="color: #800000; font-weight: bold;">1</span>. row <span style="color: #808080;">***************************</span><span style="color: #000000;">
               Slave_IO_State: Waiting </span><span style="color: #0000ff;">for</span> master <span style="color: #0000ff;">to</span><span style="color: #000000;"> send event
                  Master_Host: </span><span style="color: #800000; font-weight: bold;">192.168</span>.<span style="color: #800000; font-weight: bold;">2.128</span><span style="color: #000000;">
                  Master_User: repl
                  Master_Port: </span><span style="color: #800000; font-weight: bold;">3306</span><span style="color: #000000;">
                Connect_Retry: </span><span style="color: #800000; font-weight: bold;">60</span><span style="color: #000000;">
              Master_Log_File: mysql</span><span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000004</span><span style="color: #000000;">
          Read_Master_Log_Pos: </span><span style="color: #800000; font-weight: bold;">472</span><span style="color: #000000;">
               Relay_Log_File: localhost</span><span style="color: #808080;">-</span>relay<span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000002</span><span style="color: #000000;">
                Relay_Log_Pos: </span><span style="color: #800000; font-weight: bold;">480</span><span style="color: #000000;">
        Relay_Master_Log_File: mysql</span><span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000004</span><span style="color: #000000;">
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes</span></pre>
</div>
<p>&nbsp;</p>
<p>在slave master04 192.168.2.130上操作，导入备份，执行同步操作，如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ mysql -uroot -p123456 &lt; ./all.sql</pre>
</div>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span><span style="color: #000000;"> slave stop;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected, <span style="color: #800000; font-weight: bold;">1</span> warning (<span style="color: #800000; font-weight: bold;">0.00</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span>  CHANGE MASTER <span style="color: #0000ff;">TO</span> MASTER_HOST<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">192.168.2.128</span><span style="color: #ff0000;">'</span>,MASTER_USER<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">repl</span><span style="color: #ff0000;">'</span>, MASTER_PASSWORD<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">123456</span><span style="color: #ff0000;">'</span>,MASTER_LOG_FILE<span style="color: #808080;">=</span><span style="color: #ff0000;">'</span><span style="color: #ff0000;">mysql-bin.000004</span><span style="color: #ff0000;">'</span>,MASTER_LOG_POS<span style="color: #808080;">=</span><span style="color: #800000; font-weight: bold;">245</span><span style="color: #000000;">;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.04</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span><span style="color: #000000;"> slave start;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span><span style="color: #000000;"> show slave status\G
</span><span style="color: #808080;">***************************</span> <span style="color: #800000; font-weight: bold;">1</span>. row <span style="color: #808080;">***************************</span><span style="color: #000000;">
               Slave_IO_State: Waiting </span><span style="color: #0000ff;">for</span> master <span style="color: #0000ff;">to</span><span style="color: #000000;"> send event
                  Master_Host: </span><span style="color: #800000; font-weight: bold;">192.168</span>.<span style="color: #800000; font-weight: bold;">2.128</span><span style="color: #000000;">
                  Master_User: repl
                  Master_Port: </span><span style="color: #800000; font-weight: bold;">3306</span><span style="color: #000000;">
                Connect_Retry: </span><span style="color: #800000; font-weight: bold;">60</span><span style="color: #000000;">
              Master_Log_File: mysql</span><span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000004</span><span style="color: #000000;">
          Read_Master_Log_Pos: </span><span style="color: #800000; font-weight: bold;">472</span><span style="color: #000000;">
               Relay_Log_File: localhost</span><span style="color: #808080;">-</span>relay<span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000002</span><span style="color: #000000;">
                Relay_Log_Pos: </span><span style="color: #800000; font-weight: bold;">480</span><span style="color: #000000;">
        Relay_Master_Log_File: mysql</span><span style="color: #808080;">-</span>bin.<span style="color: #800000; font-weight: bold;">000004</span><span style="color: #000000;">
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes</span></pre>
</div>
<p>（6）两台slave服务器设置read_only（<span style="color: #0000ff;">从库对外提供读服务，之所以没有写进配置文件，是因为随时slave会提升为master</span>）</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ mysql -uroot -p123456 -e <span style="color: #800000;">"</span><span style="color: #800000;">set global read_only=1</span><span style="color: #800000;">"</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ mysql -uroot -p123456 -e <span style="color: #800000;">"</span><span style="color: #800000;">set global read_only=1</span><span style="color: #800000;">"</span></pre>
</div>
<p>（7）创建监控用户（在master上执行，也就是server02 192.168.2.128）：</p>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span> <span style="color: #0000ff;">grant</span> <span style="color: #808080;">all</span> <span style="color: #0000ff;">privileges</span> <span style="color: #0000ff;">on</span> <span style="color: #808080;">*</span>.<span style="color: #808080;">*</span> <span style="color: #0000ff;">to</span> <span style="color: #ff0000;">'</span><span style="color: #ff0000;">root</span><span style="color: #ff0000;">'</span>@<span style="color: #ff0000;">'</span><span style="color: #ff0000;">192.168.2.%</span><span style="color: #ff0000;">'</span> identified  <span style="color: #0000ff;">by</span> <span style="color: #ff0000;">'</span><span style="color: #ff0000;">123456</span><span style="color: #ff0000;">'</span><span style="color: #000000;">; 
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span> flush  <span style="color: #0000ff;">privileges</span><span style="color: #000000;">;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.01</span><span style="color: #000000;"> sec)

mysql</span><span style="color: #808080;">&gt;</span></pre>
</div>
<p>到这里整个集群环境已经搭建完毕，剩下的就是配置MHA软件了。</p>
<p>&nbsp;</p>
<p><strong>5.配置MHA</strong></p>
<p>（1）创建MHA的工作目录，并且创建相关配置文件（<span style="color: #0000ff;">在软件包解压后的目录里面有样例配置文件</span>）。</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">mkdir</span> -p /etc/<span style="color: #000000;">masterha
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">cp</span> mha4mysql-manager-<span style="color: #800080;">0.56</span>/samples/conf/app1.cnf /etc/masterha/</pre>
</div>
<p>修改app1.cnf配置文件，修改后的文件内容如下（<span style="color: #0000ff;">注意，配置文件中的注释需要去掉，我这里是为了解释清楚</span>）：</p>
<div class="cnblogs_code">
<pre>[root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> ~]# <span style="color: #0000ff;">cat</span> /etc/masterha/<span style="color: #000000;">app1.cnf 
[server default]
manager_workdir</span>=/var/log/masterha/app1.log                           <span style="color: #008000;">//</span><span style="color: #008000;">设置manager的工作目录</span>
manager_log=/var/log/masterha/app1/manager.log                       <span style="color: #008000;">//</span><span style="color: #008000;">设置manager的日志</span>
master_binlog_dir=/data/mysql                                        <span style="color: #008000;">//</span><span style="color: #008000;">设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span>
master_ip_failover_script= /usr/local/bin/master_ip_failover         <span style="color: #008000;">//</span><span style="color: #008000;">设置自动failover时候的切换脚本</span>
master_ip_online_change_script= /usr/local/bin/master_ip_online_change  <span style="color: #008000;">//</span><span style="color: #008000;">设置手动切换时候的切换脚本</span>
password=<span style="color: #800080;">123456</span>                                                        <span style="color: #008000;">//</span><span style="color: #008000;">设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</span>
user=<span style="color: #000000;">root               设置监控用户root
ping_interval</span>=<span style="color: #800080;">1</span>                                                 <span style="color: #008000;">//</span><span style="color: #008000;">设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover</span>
remote_workdir=/tmp                                             <span style="color: #008000;">//</span><span style="color: #008000;">设置远端mysql在发生切换时binlog的保存位置</span>
repl_password=<span style="color: #800080;">123456</span>                                            <span style="color: #008000;">//</span><span style="color: #008000;">设置复制用户的密码</span>
repl_user=repl                                                  <span style="color: #008000;">//</span><span style="color: #008000;">设置复制环境中的复制用户名</span>
report_script=/usr/local/bin/send_report                            <span style="color: #008000;">//</span><span style="color: #008000;">设置发生切换后发送的报警的脚本</span>
secondary_check_script= /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --master_port=<span style="color: #800080;">3306</span>                                                                          <span style="color: #008000;">//</span><span style="color: #008000;">一旦MHA到server02的监控之间出现问题，MHA Manager将会尝试从server03登录到server02</span>
shutdown_script=<span style="color: #800000;">""</span>                                             <span style="color: #008000;">//</span><span style="color: #008000;">设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span>
ssh_user=root                                                  <span style="color: #008000;">//</span><span style="color: #008000;">设置ssh的登录用户名</span>
<span style="color: #000000;">
[server1]
</span><span style="color: #0000ff;">hostname</span>=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span><span style="color: #000000;">

[server2]
</span><span style="color: #0000ff;">hostname</span>=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span><span style="color: #000000;">
candidate_master</span>=<span style="color: #800080;">1</span>
<span style="color: #008000;">                                                             //</span><span style="color: #008000;">设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave</span>
check_repl_delay=<span style="color: #800080;">0</span>                                           <span style="color: #008000;">//</span><span style="color: #008000;">默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span>
<span style="color: #000000;">
[server3]
</span><span style="color: #0000ff;">hostname</span>=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span></pre>
</div>
<p>(2)设置relay log的清除方式（<span style="color: #0000ff;">在每个slave节点上</span>）：</p>
<p>在slave master03 192.168.2.129操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ mysql -uroot -p123456 -e <span style="color: #800000;">"</span><span style="color: #800000;">set global relay_log_purge=0</span><span style="color: #800000;">"</span></pre>
</div>
<p>在slave master04 192.168.2.130操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ mysql -uroot -p123456 -e <span style="color: #800000;">"</span><span style="color: #800000;">set global relay_log_purge=0</span><span style="color: #800000;">"</span></pre>
</div>
<p>注意：</p>
<p><span style="color: #0000ff;">MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</span></p>
<p>设置定期清理relay脚本（<span style="color: #0000ff;">两台slave服务器</span>）：</p>
<p>在slave master03 192.168.2.129操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">cat</span> purge_relay_log.<span style="color: #0000ff;">sh</span><span style="color: #000000;"> 
#</span>!/bin/<span style="color: #000000;">bash
user</span>=<span style="color: #000000;">root
</span><span style="color: #0000ff;">passwd</span>=<span style="color: #800080;">123456</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span><span style="color: #000000;">
log_dir</span>=<span style="color: #800000;">'</span><span style="color: #800000;">/data/masterha/log</span><span style="color: #800000;">'</span><span style="color: #000000;">
work_dir</span>=<span style="color: #800000;">'</span><span style="color: #800000;">/data</span><span style="color: #800000;">'</span><span style="color: #000000;">
purge</span>=<span style="color: #800000;">'</span><span style="color: #800000;">/usr/local/bin/purge_relay_logs</span><span style="color: #800000;">'</span>

<span style="color: #0000ff;">if</span> [ ! -<span style="color: #000000;">d $log_dir ]
</span><span style="color: #0000ff;">then</span>
   <span style="color: #0000ff;">mkdir</span> $log_dir -<span style="color: #000000;">p
</span><span style="color: #0000ff;">fi</span><span style="color: #000000;">

$purge </span>--user=$user --password=$<span style="color: #0000ff;">passwd</span> --disable_relay_log_purge --port=$port --workdir=$work_dir &gt;&gt; $log_dir/purge_relay_logs.log <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span>

<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ crontab -<span style="color: #000000;">l
</span><span style="color: #800080;">0</span> <span style="color: #800080;">4</span> * * * /bin/bash /root/purge_relay_log.<span style="color: #0000ff;">sh</span></pre>
</div>
<p>在slave master03 192.168.2.130操作跟上面是一样的，这里不演示了。</p>
<p>参数说明：</p>
<div class="cnblogs_code">
<pre>--user mysql                      <span style="color: #008000;">//</span><span style="color: #008000;">用户名</span>
--password mysql                  <span style="color: #008000;">//</span><span style="color: #008000;">密码</span>
--port                            <span style="color: #008000;">//</span><span style="color: #008000;">端口号</span>
--workdir                         <span style="color: #008000;">//</span><span style="color: #008000;">指定创建relay log的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</span>
--disable_relay_log_purge         <span style="color: #008000;">//</span><span style="color: #008000;">默认情况下，如果relay_log_purge=1，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_log_purge=1的情况下会将relay_log_purge设置为0。清理relay log之后，最后将参数设置为OFF。</span></pre>
</div>
<p>purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况:</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ purge_relay_logs --user=root --password=<span style="color: #800080;">123456</span> --port=<span style="color: #800080;">3306</span> -disable_relay_log_purge --workdir=/data/ 
<span style="color: #800080;">2015</span>-<span style="color: #800080;">01</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">30</span>:<span style="color: #800080;">51</span><span style="color: #000000;">: purge_relay_logs script started.
 Found relay_log.</span><span style="color: #0000ff;">info</span>: /data/mysql/relay-log.<span style="color: #0000ff;">info</span><span style="color: #000000;">
 Removing hard linked relay log files localhost</span>-relay-bin* under /data/.. <span style="color: #0000ff;">done</span><span style="color: #000000;">.
 Current relay log </span><span style="color: #0000ff;">file</span>: /data/mysql/localhost-relay-bin.<span style="color: #800080;">000002</span><span style="color: #000000;">
 Archiving unused relay log files (up to </span>/data/mysql/localhost-relay-bin.<span style="color: #800080;">000001</span><span style="color: #000000;">) ...
 Creating hard link </span><span style="color: #0000ff;">for</span> /data/mysql/localhost-relay-bin.<span style="color: #800080;">000001</span> under /data<span style="color: #008000;">//</span><span style="color: #008000;">localhost-relay-bin.000001 .. ok.</span>
 Creating hard links <span style="color: #0000ff;">for</span><span style="color: #000000;"> unused relay log files completed.
 Executing SET GLOBAL relay_log_purge</span>=<span style="color: #800080;">1</span>; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay log files (<span style="color: #0000ff;">if</span> it keeps up); SET GLOBAL relay_log_purge=<span style="color: #800080;">0</span><span style="color: #000000;">; .. ok.
 Removing hard linked relay log files localhost</span>-relay-bin* under /data/.. <span style="color: #0000ff;">done</span><span style="color: #000000;">.
</span><span style="color: #800080;">2015</span>-<span style="color: #800080;">01</span>-<span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">30</span>:<span style="color: #800080;">54</span>: All relay log purging operations succeeded.</pre>
</div>
<p>&nbsp;</p>
<p>6.检查SSH配置(server01 192.168.2.131 Monitor 监控节点上操作)，如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_ssh --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting SSH connection tests..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [debug]  Connecting via SSH from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">22</span>) to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">22</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [debug]   ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">12</span>:<span style="color: #800080;">31</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] All SSH connection tests passed successfully.</pre>
</div>
<p>可以看见各个节点ssh验证都是ok的。</p>
<p>&nbsp;</p>
<p>7.检查整个复制环境状况(server01 192.168.2.131 Monitor 监控节点上操作)，如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_repl --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   Executing command: save_binary_logs --command=test --start_pos=<span style="color: #800080;">4</span> --binlog_dir=/data/mysql --output_file=/tmp/save_binary_logs_test --manager_version=<span style="color: #800080;">0.56</span> --start_file=mysql-bin.<span style="color: #800080;">000004</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   Connecting to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">).. 
  Creating </span>/tmp <span style="color: #0000ff;">if</span><span style="color: #000000;"> not exists..    ok.
  Checking output directory is accessible or not..
   ok.
  Binlog found at </span>/data/mysql, up to mysql-bin.<span style="color: #800080;">000004</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master setting check <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   Executing command : apply_diff_relay_logs --command=test --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --slave_port=<span style="color: #800080;">3306</span> --workdir=/tmp --target_version=<span style="color: #800080;">5.</span>5.6<span style="color: #800080;">0</span>-log --manager_version=<span style="color: #800080;">0.56</span> --relay_log_info=/data/mysql/relay-log.<span style="color: #0000ff;">info</span>  --relay_dir=/data/mysql/  --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">11</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   Connecting to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">22</span><span style="color: #000000;">).. 
Can</span><span style="color: #800000;">'</span><span style="color: #800000;">t exec "mysqlbinlog": 没有那个文件或目录 at /usr/local/share/perl5/MHA/BinlogManager.pm line 99.</span>
mysqlbinlog version not found!<span style="color: #000000;">
 at </span>/usr/local/bin/apply_diff_relay_logs line <span style="color: #800080;">463</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">12</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln193] Slaves settings check failed!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">12</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/<span style="color: #000000;">MasterMonitor.pm, ln372] Slave configuration failed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">12</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln383] Error happend on checking configurations.  at /usr/local/bin/masterha_check_repl line <span style="color: #800080;">48</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">12</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/<span style="color: #000000;">MasterMonitor.pm, ln478] Error happened on monitoring servers.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">08</span>:<span style="color: #800080;">12</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">1</span><span style="color: #000000;"> (Not master dead).

MySQL Replication Health is NOT OK</span>!
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>如果发现如下错误：</p>
<div class="cnblogs_code">
<pre>Can<span style="color: #800000;">'</span><span style="color: #800000;">t exec "mysqlbinlog": No such file or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 99.</span>
mysqlbinlog version not found!</pre>
</div>
<div class="cnblogs_code">
<pre>Testing mysql connection and privileges..<span style="color: #0000ff;">sh</span><span style="color: #000000;">: mysql: command not found
mysql command failed with rc </span><span style="color: #800080;">127</span>:<span style="color: #800080;">0</span>!</pre>
</div>
<p>可以通过以下方法解决（<span style="color: #0000ff;">在所有节点上执行</span>）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysqlbinlog /usr/local/bin/<span style="color: #000000;">mysqlbinlog
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysql /usr/local/bin/<span style="color: #000000;">mysql 


</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysqlbinlog /usr/local/bin/<span style="color: #000000;">mysqlbinlog
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysql /usr/local/bin/<span style="color: #000000;">mysql 


</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysqlbinlog /usr/local/bin/<span style="color: #000000;">mysqlbinlog
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> [root ~]$ <span style="color: #0000ff;">ln</span> -s /usr/local/mysql/bin/mysql /usr/local/bin/mysql </pre>
</div>
<p>再进行检查</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_repl --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking master_ip_failover_script status:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;"> 
Bareword </span><span style="color: #800000;">"</span><span style="color: #800000;">FIXME_xxx</span><span style="color: #800000;">"</span> not allowed <span style="color: #0000ff;">while</span> <span style="color: #800000;">"</span><span style="color: #800000;">strict subs</span><span style="color: #800000;">"</span> <span style="color: #0000ff;">in</span> use at /usr/local/bin/master_ip_failover line <span style="color: #800080;">88</span><span style="color: #000000;">.
Execution of </span>/usr/local/bin/<span style="color: #000000;">master_ip_failover aborted due to compilation errors.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln214]  Failed to get master_ip_failover_script status with return code <span style="color: #800080;">255</span>:<span style="color: #800080;">0</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln383] Error happend on checking configurations.  at /usr/local/bin/masterha_check_repl line <span style="color: #800080;">48</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/<span style="color: #000000;">MasterMonitor.pm, ln478] Error happened on monitoring servers.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">19</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">1</span><span style="color: #000000;"> (Not master dead).

MySQL Replication Health is NOT OK</span>!
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>还是报错，纠结N久，才发现原因是：原来Failover两种方式：一种是虚拟IP地址，一种是全局配置文件。MHA并没有限定使用哪一种方式，而是让用户自己选择，虚拟IP地址的方式会牵扯到其它的软件,比如keepalive软件，而且还要修改脚本master_ip_failover。</p>
<p><br />所以先暂时注释master_ip_failover_script= /usr/local/bin/master_ip_failover这个选项。后面引入keepalived后和修改该脚本以后再开启该选项</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">grep</span> master_ip_failover /etc/masterha/<span style="color: #000000;">app1.cnf
#master_ip_failover_script</span>= /usr/local/bin/master_ip_failover </pre>
</div>
<p>再次进行状态查看：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_repl --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Slaves settings check <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] master_ip_failover_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">23</span>:<span style="color: #800080;">57</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">0</span><span style="color: #000000;"> (Not master dead).

MySQL Replication Health is OK.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>已经没有明显报错，只有两个警告而已，复制也显示正常了,哈哈，没报错了，先乐一会^0^</p>
<p>&nbsp;</p>
<p>8.检查MHA Manager的状态<br />通过master_check_status脚本查看Manager的状态：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_status --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
app1 is stopped(</span><span style="color: #800080;">2</span>:NOT_RUNNING).</pre>
</div>
<p>注意：如果正常，会显示"PING_OK"，否则会显示"NOT_RUNNING"，这代表MHA监控没有开启。</p>
<p>&nbsp;</p>
<p>9.开启MHA Manager监控(server01 192.168.2.131操作)如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">mkdir</span> -p  /var/log/masterha/app1/
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/<span style="color: #0000ff;">null</span> &gt; /var/log/masterha/app1/manager.log <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span> &amp;<span style="color: #000000;">  
[</span><span style="color: #800080;">1</span>] <span style="color: #800080;">13014</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$</pre>
</div>
<p>启动参数说明：</p>
<div class="cnblogs_code">
<pre>--remove_dead_master_conf      <span style="color: #008000;">//</span><span style="color: #008000;">该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span>

--manger_log                   <span style="color: #008000;">//</span><span style="color: #008000;">日志存放位置</span>

--ignore_last_failover         <span style="color: #008000;">//</span><span style="color: #008000;">在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足8小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</span></pre>
</div>
<p>查看MHA Manager监控是否正常：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_status --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
app1 (pid:</span><span style="color: #800080;">13014</span>) is running(<span style="color: #800080;">0</span>:PING_OK), master:<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span></pre>
</div>
<p>可以看见已经在监控了，而且master的主机为192.168.2.128</p>
<p>&nbsp;</p>
<p>10.查看启动日志(server01 192.168.2.131操作)如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$  <span style="color: #0000ff;">tail</span> -n20 /var/log/masterha/app1/<span style="color: #000000;">manager.log
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   Connecting to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">22</span><span style="color: #000000;">).. 
  Checking slave recovery environment settings..
    Opening </span>/data/mysql/relay-log.<span style="color: #0000ff;">info</span><span style="color: #000000;"> ... ok.
    Relay log found at </span>/data/mysql, up to localhost-relay-bin.<span style="color: #800080;">000002</span><span style="color: #000000;">
    Temporary relay log </span><span style="color: #0000ff;">file</span> is /data/mysql/localhost-relay-bin.<span style="color: #800080;">000002</span><span style="color: #000000;">
    Testing mysql connection and privileges.. </span><span style="color: #0000ff;">done</span><span style="color: #000000;">.
    Testing mysqlbinlog output.. </span><span style="color: #0000ff;">done</span><span style="color: #000000;">.
    Cleaning up test </span><span style="color: #0000ff;">file</span>(s).. <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Slaves settings check <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] master_ip_failover_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set master <span style="color: #0000ff;">ping</span> interval <span style="color: #800080;">1</span><span style="color: #000000;"> seconds.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set secondary check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168.<span style="color: #800080;">2.128</span></span> --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting <span style="color: #0000ff;">ping</span> health check on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">27</span>:<span style="color: #800080;">22</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Ping(SELECT) succeeded, waiting <span style="color: #0000ff;">until</span> MySQL doesn<span style="color: #800000;">'</span><span style="color: #800000;">t respond..</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>其中"Ping(SELECT) succeeded, waiting until MySQL doesn't respond.."说明整个系统已经开始监控了。</p>
<p>&nbsp;</p>
<p>11.关闭MHA Manage监控(server01 192.168.2.131操作)如下：</p>
<p>关闭很简单，使用masterha_stop命令完成。（<span style="color: #0000ff;">只是演示关闭，在测试中，必须是开启的状态，如果关了，在测试的时候务必记得开启</span>）</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_stop --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Stopped app1 successfully.
[</span><span style="color: #800080;">1</span>]+  Exit <span style="color: #800080;">1</span>                  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/<span style="color: #0000ff;">null</span> &gt; /var/log/masterha/app1/manager.log <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>&nbsp;</p>
<p>12.配置VIP<br />vip配置可以采用两种方式，一种通过keepalived的方式管理虚拟ip的浮动；另外一种通过脚本方式启动虚拟ip的方式（即不需要keepalived或者heartbeat类似的软件）。<br />下面先介绍通过安装keepalived来管理虚拟IP的浮动：</p>
<p>（1）下载软件进行并进行安装（两台master，准确的说一台是master，另外一台是备选master，在没有切换以前是slave）server02&nbsp;192.168.2.128操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">wget</span> http:<span style="color: #008000;">//</span><span style="color: #008000;">www.keepalived.org/software/keepalived-1.2.12.tar.gz</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">tar</span> xf keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>.<span style="color: #0000ff;">tar</span><span style="color: #000000;">.gz 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ cd keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ ./configure --prefix=/usr/local/<span style="color: #000000;">keepalived
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">make</span> &amp;&amp;  <span style="color: #0000ff;">make</span> <span style="color: #0000ff;">install</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cp</span> /usr/local/keepalived/etc/rc.d/init.d/keepalived /etc/init.d/
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cp</span> /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">mkdir</span> /etc/<span style="color: #000000;">keepalived
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cp</span> /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cp</span> /usr/local/keepalived/sbin/keepalived /usr/sbin/</pre>
</div>
<p>server03&nbsp;192.168.2.129也要执行上面的操作，安装是一样的，配置文件不一样，这里不演示，自已安装哈</p>
<p>&nbsp;</p>
<p>（2）配置keepalived的配置文件，在master上配置（server02 192.168.2.128）操作如下:</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cat</span> /etc/keepalived/<span style="color: #000000;">keepalived.conf 
</span>! Configuration File <span style="color: #0000ff;">for</span><span style="color: #000000;"> keepalived

global_defs {
     notification_email {
     saltstack@</span><span style="color: #800080;">163</span><span style="color: #000000;">.com
   }
   notification_email_from dba@dbserver.com
   smtp_server </span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span><span style="color: #000000;">
   smtp_connect_timeout </span><span style="color: #800080;">30</span><span style="color: #000000;">
   router_id MySQL</span>-<span style="color: #000000;">HA
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id </span><span style="color: #800080;">51</span><span style="color: #000000;">
    priority </span><span style="color: #800080;">150</span><span style="color: #000000;">
    advert_int </span><span style="color: #800080;">1</span><span style="color: #000000;">
    nopreempt

    authentication {
    auth_type PASS
    auth_pass </span><span style="color: #800080;">1111</span><span style="color: #000000;">
    }

    virtual_ipaddress {
        </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;">
    }
}
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$</pre>
</div>
<p>其中router_id MySQL HA表示设定keepalived组的名称，将192.168.2.88这个虚拟ip绑定到该主机的eth0网卡上，并且设置了状态为backup模式，将keepalived的模式设置为非抢占模式（nopreempt），priority 150表示设置的优先级为150。下面的配置略有不同，但是都是一个意思。（<span style="color: #0000ff;">还有一个细节要注意的，要看清楚自己的网卡是eth0做模拟VIP,还是eth1</span>）</p>
<p>&nbsp;</p>
<p>在候选master上配置（server03 192.168.2.129）操作如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">cat</span> /etc/keepalived/<span style="color: #000000;">keepalived.conf 
</span>! Configuration File <span style="color: #0000ff;">for</span><span style="color: #000000;"> keepalived

global_defs {
     notification_email {
     saltstack@</span><span style="color: #800080;">163</span><span style="color: #000000;">.com
   }
   notification_email_from dba@dbserver.com
   smtp_server </span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span><span style="color: #000000;">
   smtp_connect_timeout </span><span style="color: #800080;">30</span><span style="color: #000000;">
   router_id MySQL</span>-<span style="color: #000000;">HA
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id </span><span style="color: #800080;">51</span><span style="color: #000000;">
    priority </span><span style="color: #800080;">120</span><span style="color: #000000;">
    advert_int </span><span style="color: #800080;">1</span><span style="color: #000000;">
    nopreempt

    authentication {
    auth_type PASS
    auth_pass </span><span style="color: #800080;">1111</span><span style="color: #000000;">
    }

    virtual_ipaddress {
        </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;">
    }
}
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ </pre>
</div>
<p>（3）启动keepalived服务，在master上启动并查看日志（server02 192.168.2.128）操作如下:</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ /etc/init.d/<span style="color: #000000;">keepalived start
正在启动 keepalived：                                      [确定]
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$  <span style="color: #0000ff;">tail</span> -f /var/log/<span style="color: #000000;">messages
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">20</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span><span style="color: #000000;">]: Registering Kernel netlink reflector
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">20</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span><span style="color: #000000;">]: Registering Kernel netlink command channel
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">20</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span>]: Opening <span style="color: #0000ff;">file</span> <span style="color: #800000;">'</span><span style="color: #800000;">/etc/keepalived/keepalived.conf</span><span style="color: #800000;">'</span><span style="color: #000000;">.
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">20</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span>]: Configuration is using : <span style="color: #800080;">7105</span><span style="color: #000000;"> Bytes
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">20</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span><span style="color: #000000;">]: Using LinkWatch kernel netlink reflector...
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">23</span> localhost Keepalived_vrrp[<span style="color: #800080;">4639</span><span style="color: #000000;">]: VRRP_Instance(VI_1) Transition to MASTER STATE
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">24</span> localhost Keepalived_vrrp[<span style="color: #800080;">4639</span><span style="color: #000000;">]: VRRP_Instance(VI_1) Entering MASTER STATE
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">24</span> localhost Keepalived_vrrp[<span style="color: #800080;">4639</span><span style="color: #000000;">]: VRRP_Instance(VI_1) setting protocol VIPs.
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">24</span> localhost Keepalived_vrrp[<span style="color: #800080;">4639</span>]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 <span style="color: #0000ff;">for</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;">
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">24</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4638</span>]: Netlink reflector reports IP <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;"> added
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">47</span>:<span style="color: #800080;">29</span> localhost Keepalived_vrrp[<span style="color: #800080;">4639</span>]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 <span style="color: #0000ff;">for</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span></pre>
</div>
<p>启动候选master的keepalived（server03 192.168.2.129）操作如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ /etc/init.d/<span style="color: #000000;">keepalived start
正在启动 keepalived：                                      [确定]
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span><span style="color: #000000;">]$ 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">tail</span> -f /var/log/<span style="color: #000000;">messages           
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: Registering gratuitous ARP shared channel
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4989</span><span style="color: #000000;">]: Registering Kernel netlink command channel
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span>]: Opening <span style="color: #0000ff;">file</span> <span style="color: #800000;">'</span><span style="color: #800000;">/etc/keepalived/keepalived.conf</span><span style="color: #800000;">'</span><span style="color: #000000;">.
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4989</span>]: Opening <span style="color: #0000ff;">file</span> <span style="color: #800000;">'</span><span style="color: #800000;">/etc/keepalived/keepalived.conf</span><span style="color: #800000;">'</span><span style="color: #000000;">.
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4989</span>]: Configuration is using : <span style="color: #800080;">7105</span><span style="color: #000000;"> Bytes
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4989</span><span style="color: #000000;">]: Using LinkWatch kernel netlink reflector...
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span>]: Configuration is using : <span style="color: #800080;">62850</span><span style="color: #000000;"> Bytes
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: Using LinkWatch kernel netlink reflector...
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: VRRP_Instance(VI_1)<span style="color: #ff0000;"> Entering BACKUP STATE</span>
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">31</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span>]: VRRP sockpool: [ifindex(<span style="color: #800080;">2</span>), proto(<span style="color: #800080;">112</span>), unicast(<span style="color: #800080;">0</span>), fd(<span style="color: #800080;">10</span>,<span style="color: #800080;">11</span><span style="color: #000000;">)]
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">34</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: VRRP_Instance(VI_1) Transition to MASTER STATE
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">35</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: VRRP_Instance(VI_1) Entering MASTER STATE
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">35</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span><span style="color: #000000;">]: VRRP_Instance(VI_1) setting protocol VIPs.
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">35</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span>]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 <span style="color: #0000ff;">for</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;">
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">35</span> localhost Keepalived_healthcheckers[<span style="color: #800080;">4989</span>]: Netlink reflector reports IP <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span><span style="color: #000000;"> added
Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">40</span> localhost Keepalived_vrrp[<span style="color: #800080;">4990</span>]: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 <span style="color: #0000ff;">for</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span></pre>
</div>
<p>（4）查看绑定情况</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span><span style="color: #000000;">]$ ip a
</span><span style="color: #800080;">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color: #800080;">16436</span><span style="color: #000000;"> qdisc noqueue state UNKNOWN 
    link</span>/loopback <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> brd <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">
    inet </span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span>/<span style="color: #800080;">8</span><span style="color: #000000;"> scope host lo
    inet6 ::</span><span style="color: #800080;">1</span>/<span style="color: #800080;">128</span><span style="color: #000000;"> scope host 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color: #800080;">1500</span> qdisc pfifo_fast state UP qlen <span style="color: #800080;">1000</span><span style="color: #000000;">
    link</span>/ether <span style="color: #800080;">00</span>:0c:<span style="color: #800080;">29</span>:<span style="color: #800080;">86</span><span style="color: #000000;">:dc:2a brd ff:ff:ff:ff:ff:ff
    inet </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>/<span style="color: #800080;">24</span> brd <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span><span style="color: #000000;"> scope global eth0
    inet </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">32</span><span style="color: #000000;"> scope global eth0
    inet6 fe80::20c:29ff:fe86:dc2a</span>/<span style="color: #800080;">64</span><span style="color: #000000;"> scope link 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ </pre>
</div>
<p>发现已经将虚拟IP 192.168.2.88绑定了master02 192.168.2.128的网卡eth0上了</p>
<p>从上面的信息可以看到keepalived已经配置成功。</p>
<p><span style="color: #0000ff;">注意：</span><br /><span style="color: #0000ff;">上面两台服务器的keepalived都设置为了BACKUP模式，在keepalived中2种模式，分别是master-&gt;backup模式和backup-&gt;backup模式。这两种模式有很大区别。在master-&gt;backup模式下，一旦主库宕机，虚拟ip会自动漂移到从库，当主库修复后，keepalived启动后，还会把虚拟ip抢占过来，即使设置了非抢占模式（nopreempt）抢占ip的动作也会发生。在backup-&gt;backup模式下，当主库宕机后虚拟ip会自动漂移到从库上，当原主库恢复和keepalived服务启动后，并不会抢占新主的虚拟ip，即使是优先级高于从库的优先级别，也不会发生抢占。为了减少ip漂移次数，通常是把修复好的主库当做新的备库。</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000;">（5）MHA引入keepalived（MySQL服务进程挂掉时通过MHA 停止keepalived）:</span></p>
<p><span style="color: #000000;">要想把keepalived服务引入MHA，我们只需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</span></p>
<p><span style="color: #000000;">1、编辑脚本/usr/local/bin/master_ip_failover，修改后如下（server01 192.168.2.131）操作：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">cat</span> /usr/local/bin/<span style="color: #000000;">master_ip_failover 
#</span>!/usr/bin/<span style="color: #0000ff;">env</span> <span style="color: #0000ff;">perl</span><span style="color: #000000;">
use strict;
use warnings FATAL </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">all</span><span style="color: #800000;">'</span><span style="color: #000000;">;

use Getopt::Long;

my (
    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,
    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port
);

my $vip </span>= <span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.88</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $ssh_start_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/etc/init.d/keepalived start</span><span style="color: #800000;">"</span><span style="color: #000000;">;
my $ssh_stop_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/etc/init.d/keepalived stop</span><span style="color: #800000;">"</span><span style="color: #000000;">;

GetOptions(
    </span><span style="color: #800000;">'</span><span style="color: #800000;">command=s</span><span style="color: #800000;">'</span>          =&gt;<span style="color: #000000;"> \$command,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ssh_user=s</span><span style="color: #800000;">'</span>         =&gt;<span style="color: #000000;"> \$ssh_user,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_host=s</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$orig_master_host,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_ip=s</span><span style="color: #800000;">'</span>   =&gt;<span style="color: #000000;"> \$orig_master_ip,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_port=i</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$orig_master_port,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_host=s</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_master_host,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_ip=s</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$new_master_ip,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_port=i</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_master_port,
);

exit </span>&amp;<span style="color: #000000;">main();

sub main {

    print </span><span style="color: #800000;">"</span><span style="color: #800000;">\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;

    </span><span style="color: #0000ff;">if</span> ( $command eq <span style="color: #800000;">"</span><span style="color: #800000;">stop</span><span style="color: #800000;">"</span> || $command eq <span style="color: #800000;">"</span><span style="color: #800000;">stopssh</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {

        my $exit_code </span>= <span style="color: #800080;">1</span><span style="color: #000000;">;
        eval {
            print </span><span style="color: #800000;">"</span><span style="color: #800000;">Disabling the VIP on old master: $orig_master_host \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            </span>&amp;<span style="color: #000000;">stop_vip();
            $exit_code </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
        };
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
            warn </span><span style="color: #800000;">"</span><span style="color: #800000;">Got Error: $@\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">start</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {

        my $exit_code </span>= <span style="color: #800080;">10</span><span style="color: #000000;">;
        eval {
            print </span><span style="color: #800000;">"</span><span style="color: #800000;">Enabling the VIP - $vip on the new master - $new_master_host \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            </span>&amp;<span style="color: #000000;">start_vip();
            $exit_code </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
        };
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
            warn $@;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">status</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {
        print </span><span style="color: #800000;">"</span><span style="color: #800000;">Checking the Status of the script.. OK \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
        exit </span><span style="color: #800080;">0</span><span style="color: #000000;">;
    }
    </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        </span>&amp;<span style="color: #000000;">usage();
        exit </span><span style="color: #800080;">1</span><span style="color: #000000;">;
    }
}
sub start_vip() {
    `</span><span style="color: #0000ff;">ssh</span> $ssh_user\@$new_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_start_vip \"`;</span>
<span style="color: #000000;">}
# A simple system call that disable the VIP on the old_master
sub stop_vip() {
    `</span><span style="color: #0000ff;">ssh</span> $ssh_user\@$orig_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_stop_vip \"`;</span>
<span style="color: #000000;">}

sub usage {
    print
    </span><span style="color: #800000;">"</span><span style="color: #800000;">Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
}
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>把#master_ip_failover_script= /usr/local/bin/master_ip_failover打开</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">grep</span> <span style="color: #800000;">'</span><span style="color: #800000;">master_ip_failover_script</span><span style="color: #800000;">'</span> /etc/masterha/<span style="color: #000000;">app1.cnf
master_ip_failover_script</span>= /usr/local/bin/master_ip_failover</pre>
</div>
<p>执行检测：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_repl --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Slaves settings check <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking master_ip_failover_script status:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;"> 
Unmatched right curly bracket at </span>/usr/local/bin/master_ip_failover line <span style="color: #800080;">76</span><span style="color: #000000;">, at end of line
syntax error at </span>/usr/local/bin/master_ip_failover line <span style="color: #800080;">76</span>, near <span style="color: #800000;">"</span><span style="color: #800000;">}</span><span style="color: #800000;">"</span><span style="color: #000000;">
Execution of </span>/usr/local/bin/<span style="color: #000000;">master_ip_failover aborted due to compilation errors.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln214]  Failed to get master_ip_failover_script status with return code <span style="color: #800080;">255</span>:<span style="color: #800080;">0</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln383] Error happend on checking configurations.  at /usr/local/bin/masterha_check_repl line <span style="color: #800080;">48</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/<span style="color: #000000;">MasterMonitor.pm, ln478] Error happened on monitoring servers.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">1</span><span style="color: #000000;"> (Not master dead).

MySQL Replication Health is NOT OK</span>!</pre>
</div>
<p>报以上的错，折腾了N多人，因为好多人不懂perl，看到模板就复制别人的代码，就是在复制的进去的时候，弄乱了，又手动调一下，导致各种各样的问题，我上面就是不小心导致的报错，手动修改了（cp的时候有一行多了一个#号），报错的大部份原因是master_ip_failover脚本导致的，而不要过多花时间纠结自己是否安装时安装少了东西，怀疑自己搭建的环境问题</p>
<p>再次执行检查：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_check_repl --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Slaves settings check <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking master_ip_failover_script status:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;"> 


IN SCRIPT TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===<span style="color: #000000;">

Checking the Status of the script.. OK 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">02</span>:<span style="color: #800080;">21</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">0</span><span style="color: #000000;"> (Not master dead).

MySQL Replication Health is OK.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>可以看见已经没有报错了，再乐一会吧，哈哈&hellip;&hellip;</p>
<p>&nbsp;</p>
<p>/usr/local/bin/master_ip_failover添加或者修改的内容意思是当主库数据库发生故障时，会触发MHA切换，MHA Manager会停掉主库上的keepalived服务，触发虚拟ip漂移到备选从库，从而完成切换。当然可以在keepalived里面引入脚本，这个脚本监控mysql是否正常运行，如果不正常，则调用该脚本杀掉keepalived进程。</p>
<p>2、以下进行模拟主Master（192.168.2.128）down了：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ /etc/init.d/<span style="color: #000000;">mysqld stop
Shutting down MySQL... SUCCESS</span>! 
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$</pre>
</div>
<p>&nbsp;</p>
<p>在管理节点(server01 192.168.2.131)查看日志：（报错）</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">tail</span> -f /var/log/masterha/app1/<span style="color: #000000;">manager.log
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] master_ip_failover_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set master <span style="color: #0000ff;">ping</span> interval <span style="color: #800080;">1</span><span style="color: #000000;"> seconds.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set secondary check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168.<span style="color: #800080;">2.128</span></span> --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting <span style="color: #0000ff;">ping</span> health check on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">13</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">37</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Ping(SELECT) succeeded, waiting <span style="color: #0000ff;">until</span> MySQL doesn<span style="color: #800000;">'</span><span style="color: #800000;">t respond..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">03</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL <span style="color: #0000ff;">select</span> <span style="color: #0000ff;">ping</span>: <span style="color: #800080;">2006</span><span style="color: #000000;"> (MySQL server has gone away)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">03</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing seconary network check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168.<span style="color: #800080;">2.128</span></span> --master_port=<span style="color: #800080;">3306</span>  --user=root  --master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">03</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing SSH check script: save_binary_logs --command=test --start_pos=<span style="color: #800080;">4</span> --binlog_dir=/data/mysql --output_file=/tmp/save_binary_logs_test --manager_version=<span style="color: #800080;">0.56</span> --binlog_prefix=mysql-<span style="color: #000000;">bin
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">03</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">04</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">04</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">1</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">05</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">05</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">2</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">06</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">14</span>:<span style="color: #800080;">32</span>:<span style="color: #800080;">06</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">3</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
</span><span style="color: #0000ff;">ssh</span>: Could not resolve <span style="color: #0000ff;">hostname</span><span style="color: #000000;"> server03: Name or service not known
Monitoring server server03 is NOT reachable</span>!</pre>
</div>
<p>在管理节服务器192.168.2.131上添加hosts:</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">cat</span> /etc/<span style="color: #000000;">hosts
</span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span><span style="color: #000000;">   localhost localhost.localdomain localhost4 localhost4.localdomain4
::</span><span style="color: #800080;">1</span><span style="color: #000000;">         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> server01
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> server02
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> server03</pre>
</div>
<p>再查看日志（点下面加号可以查看日志）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">tail</span> -f /var/log/masterha/app1/manager.log</pre>
</div>
<div class="cnblogs_code" onclick="cnblogs_code_show('8391b317-a167-4cda-9520-ca6b72ed6cf5')"><img id="code_img_closed_8391b317-a167-4cda-9520-ca6b72ed6cf5" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_8391b317-a167-4cda-9520-ca6b72ed6cf5" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8391b317-a167-4cda-9520-ca6b72ed6cf5',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_8391b317-a167-4cda-9520-ca6b72ed6cf5" class="cnblogs_code_hide">
<pre>IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===<span style="color: #000000;">

Checking the Status of the script.. OK 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set master <span style="color: #0000ff;">ping</span> interval <span style="color: #800080;">1</span><span style="color: #000000;"> seconds.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set secondary check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting <span style="color: #0000ff;">ping</span> health check on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Ping(SELECT) succeeded, waiting <span style="color: #0000ff;">until</span> MySQL doesn<span style="color: #800000;">'</span><span style="color: #800000;">t respond..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL <span style="color: #0000ff;">select</span> <span style="color: #0000ff;">ping</span>: <span style="color: #800080;">2006</span><span style="color: #000000;"> (MySQL server has gone away)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing SSH check script: save_binary_logs --command=test --start_pos=<span style="color: #800080;">4</span> --binlog_dir=/data/mysql --output_file=/tmp/save_binary_logs_test --manager_version=<span style="color: #800080;">0.53</span> --binlog_prefix=mysql-<span style="color: #000000;">bin
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing seconary network check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --master_port=<span style="color: #800080;">3306</span>  --user=root  --master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> is reachable.
Monitoring server server03 is reachable, Master is not reachable from server03. OK.
Monitoring server server02 is reachable, Master is not reachable from server02. OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">48</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Master is not reachable from all other monitoring servers. Failover should start.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">49</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">1</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">2</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">3</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning] Master is not reachable from health checker!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning] Master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) is not reachable!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] SSH is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to a master server failed. Reading configuration <span style="color: #0000ff;">file</span> /etc/masterha_default.cnf and /etc/masterha/<span style="color: #000000;">app1.cnf again, and trying to connect to all servers to check server status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking slave configurations..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  read_only=<span style="color: #800080;">1</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning]  relay_log_purge=<span style="color: #800080;">0</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [warning]  relay_log_purge=<span style="color: #800080;">0</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking replication filtering settings..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Replication filtering check ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master is down!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Terminating monitoring script.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">20</span><span style="color: #000000;"> (Master dead).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterFailover version <span style="color: #800080;">0.53</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking master reachability via mysql(<span style="color: #0000ff;">double</span><span style="color: #000000;"> check)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Forcing shutdown so that applications never connect to the current master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP deactivatation script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --command=stopssh --ssh_user=<span style="color: #000000;">root  


IN SCRIPT TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===<span style="color: #000000;">

Disabling the VIP on old master: </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.1</span><span style="color: #000000;">: Getting Latest Slaves Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The latest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000014</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Latest slaves (Slaves that received relay log files to the latest):
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The oldest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000014</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Oldest slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.2</span>: Saving Dead Master<span style="color: #800000;">'</span><span style="color: #800000;">s Binlog Phase..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Fetching dead master<span style="color: #800000;">'</span><span style="color: #800000;">s binary logs..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">51</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command on the dead master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>): save_binary_logs --command=save --start_file=mysql-bin.<span style="color: #800080;">000014</span>  --start_pos=<span style="color: #800080;">107</span> --binlog_dir=/data/mysql --output_file=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span><span style="color: #000000;">
  Creating </span>/tmp <span style="color: #0000ff;">if</span><span style="color: #000000;"> not exists..    ok.
 Concat binary</span>/relay logs from mysql-bin.<span style="color: #800080;">000014</span> pos <span style="color: #800080;">107</span> to mysql-bin.<span style="color: #800080;">000014</span> EOF into /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118171151.binlog ..
  Dumping binlog format description event, from position </span><span style="color: #800080;">0</span> to <span style="color: #800080;">107</span><span style="color: #000000;">.. ok.
  Dumping effective binlog data from </span>/data/mysql/mysql-bin.<span style="color: #800080;">000014</span> position <span style="color: #800080;">107</span> to <span style="color: #0000ff;">tail</span>(<span style="color: #800080;">126</span><span style="color: #000000;">).. ok.
 Concat succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">52</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog to local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118171151.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">52</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">52</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: Determining New Master Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Finding the latest slave that has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovering other slaves..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All slaves received relay logs to the same position. No need to resync each other.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Searching new master from slaves..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Candidate masters from the configuration <span style="color: #0000ff;">file</span><span style="color: #000000;">:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Non-<span style="color: #000000;">candidate masters:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Searching from candidate_master slaves <span style="color: #0000ff;">which</span><span style="color: #000000;"> have received the latest relay log events..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] New master is <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
From:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

To:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> (new master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: New Master Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118171151.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.4</span><span style="color: #000000;">: Master Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] *<span style="color: #000000;">NOTICE: If any error happens from this phase, manual recovery is needed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000014:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log --timestamp=<span style="color: #800080;">20150118171151</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Getting new master<span style="color: #800000;">'</span><span style="color: #800000;">s binlog name and position..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  mysql-bin.<span style="color: #800080;">000005</span>:<span style="color: #800080;">61791</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span><span style="color: #000000;">;
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP activate script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">  


IN SCRIPT TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===<span style="color: #000000;">

Enabling the VIP </span>- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span> on the new master - <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] **<span style="color: #000000;"> Finished master recovery successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4</span><span style="color: #000000;">: Slaves Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.1</span><span style="color: #000000;">: Starting Parallel Slave Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave <span style="color: #0000ff;">diff</span> <span style="color: #0000ff;">file</span> generation on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">19762</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118171151.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) has the latest relay log events.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Generating relay <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.2</span><span style="color: #000000;">: Starting Parallel Slave Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">19764</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118171151.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">53</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118171151.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000014:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log --timestamp=<span style="color: #800080;">20150118171151</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118171151.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">54</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All new slave servers recovered successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">5</span><span style="color: #000000;">: New master cleanup phease..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> on the new master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master failover to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Deleted server1 entry from /etc/masterha/<span style="color: #000000;">app1.cnf .
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 

</span>----- Failover Report -----<span style="color: #000000;">

app1: MySQL Master failover </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> succeeded

Master </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> is down!<span style="color: #000000;">

Check MHA Manager logs at localhost.localdomain:</span>/var/log/masterha/app1/manager.log <span style="color: #0000ff;">for</span><span style="color: #000000;"> details.

Started automated(non</span>-<span style="color: #000000;">interactive) failover.
Invalidated master IP address on </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">.
The latest slave </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovery.
Selected </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> as a new master.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Applying all logs succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Activated master IP address.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">: This host has the latest relay log events.
Generating relay </span><span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>: OK: Applying all logs succeeded. Slave started, replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Master failover to </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending mail..
Unknown option: conf</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>3、在之前的Master（192.168.2.128）上查看一下vip：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span><span style="color: #000000;">]$ ip a
</span><span style="color: #800080;">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color: #800080;">16436</span><span style="color: #000000;"> qdisc noqueue state UNKNOWN 
    link</span>/loopback <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> brd <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">
    inet </span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span>/<span style="color: #800080;">8</span><span style="color: #000000;"> scope host lo
    inet6 ::</span><span style="color: #800080;">1</span>/<span style="color: #800080;">128</span><span style="color: #000000;"> scope host 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color: #800080;">1500</span> qdisc pfifo_fast state UP qlen <span style="color: #800080;">1000</span><span style="color: #000000;">
    link</span>/ether <span style="color: #800080;">00</span>:0c:<span style="color: #800080;">29</span>:<span style="color: #800080;">86</span><span style="color: #000000;">:dc:2a brd ff:ff:ff:ff:ff:ff
    inet </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>/<span style="color: #800080;">24</span> brd <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span><span style="color: #000000;"> scope global eth0
    inet6 fe80::20c:29ff:fe86:dc2a</span>/<span style="color: #800080;">64</span><span style="color: #000000;"> scope link 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ </pre>
</div>
<p>可以看到vip已经不在down的机器上了</p>
<p>去候选的master（server03 192.168.2.129）也就是现在的新master查看是否有vip漂过：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span><span style="color: #000000;">]$ ip a
</span><span style="color: #800080;">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color: #800080;">16436</span><span style="color: #000000;"> qdisc noqueue state UNKNOWN 
    link</span>/loopback <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span> brd <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">
    inet </span><span style="color: #800080;">127.0</span>.<span style="color: #800080;">0.1</span>/<span style="color: #800080;">8</span><span style="color: #000000;"> scope host lo
    inet6 ::</span><span style="color: #800080;">1</span>/<span style="color: #800080;">128</span><span style="color: #000000;"> scope host 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color: #800080;">1500</span> qdisc pfifo_fast state UP qlen <span style="color: #800080;">1000</span><span style="color: #000000;">
    link</span>/ether <span style="color: #800080;">00</span>:0c:<span style="color: #800080;">29</span>:<span style="color: #800080;">66</span>:<span style="color: #800080;">95</span>:<span style="color: #800080;">64</span><span style="color: #000000;"> brd ff:ff:ff:ff:ff:ff
    inet </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>/<span style="color: #800080;">24</span> brd <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span><span style="color: #000000;"> scope global eth0
    inet </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">32</span><span style="color: #000000;"> scope global eth0
    inet6 fe80::20c:29ff:fe66:</span><span style="color: #800080;">9564</span>/<span style="color: #800080;">64</span><span style="color: #000000;"> scope link 
       valid_lft forever preferred_lft forever
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ </pre>
</div>
<p>哈哈，看到vip已经成功漂移过来了。</p>
<p>&nbsp;</p>
<p>从tail -f /var/log/masterha/app1/manager.log的信息可以发现最后有这样的字眼：</p>
<div class="cnblogs_code">
<pre>The latest slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovery.
Selected </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> as a new master.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Applying all logs succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Activated master IP address.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">: This host has the latest relay log events.
Generating relay </span><span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>: OK: Applying all logs succeeded. Slave started, replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Master failover to </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">11</span>:<span style="color: #800080;">55</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]<span style="color: #ff0000;"> Sending mail..</span>
Unknown option: conf</span></pre>
</div>
<p>看到上面的Sending mail了吧，哈哈，已经正常发邮件了，看图：</p>
<p><img src="https://images0.cnblogs.com/blog/645933/201501/252038562221587.png" alt="" /></p>
<p><img src="https://images0.cnblogs.com/blog/645933/201501/252037170348783.png" alt="" /></p>
<p>发邮件的设置要在监控节点192.168.2.131上操作：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ <span style="color: #0000ff;">cat</span> /etc/masterha/app1.cnf |<span style="color: #0000ff;">grep</span> <span style="color: #800000;">"</span><span style="color: #800000;">report_script</span><span style="color: #800000;">"</span><span style="color: #000000;">
report_script</span>=/usr/local/bin/send_report</pre>
</div>
<p>send_report这个脚本在安装好软件后就会有，但我前面说了，这些脚本有很多地方不够完善，包括send_report的发邮件脚本，下面说明发设置，并把代码share出来：</p>
<p><img src="https://images0.cnblogs.com/blog/645933/201501/251118593441386.png" alt="" /></p>
<p>脚本代码：（该脚本是37wan DBA-邓亚运分享，博客地址在博文后面贴出）</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('b6522258-3162-4321-813f-818e49d6ff27')"><img id="code_img_closed_b6522258-3162-4321-813f-818e49d6ff27" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_b6522258-3162-4321-813f-818e49d6ff27" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b6522258-3162-4321-813f-818e49d6ff27',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_b6522258-3162-4321-813f-818e49d6ff27" class="cnblogs_code_hide">
<pre>#!/usr/bin/<span style="color: #0000ff;">perl</span><span style="color: #000000;">

#  Copyright (C) </span><span style="color: #800080;">2011</span><span style="color: #000000;"> DeNA Co.,Ltd.
#
#  This program is </span><span style="color: #0000ff;">free</span> software; you can redistribute it and/<span style="color: #000000;">or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version </span><span style="color: #800080;">2</span><span style="color: #000000;"> of the License, or
#  (at your option) any later version.
#
#  This program is distributed </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License </span><span style="color: #0000ff;">for</span> <span style="color: #0000ff;">more</span><span style="color: #000000;"> details.
#
#  You should have received a copy of the GNU General Public License
#   along with this program; </span><span style="color: #0000ff;">if</span> not, <span style="color: #0000ff;">write</span><span style="color: #000000;"> to the Free Software
#  Foundation, Inc.,
#  </span><span style="color: #800080;">51</span> Franklin Street, Fifth Floor, Boston, MA  <span style="color: #800080;">02110</span>-<span style="color: #800080;">1301</span><span style="color: #000000;">  USA

## Note: This is a sample script and is not complete. Modify the script based on your environment.

use strict;
use warnings FATAL </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">all</span><span style="color: #800000;">'</span><span style="color: #000000;">;
use Mail::Sender;
use Getopt::Long;

#new_master_host and new_slave_hosts are set only when recovering master succeeded
my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );
my $smtp</span>=<span style="color: #800000;">'</span><span style="color: #800000;">smtp.163.com</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $mail_from</span>=<span style="color: #800000;">'</span><span style="color: #800000;">xxxxxxx@163.com</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $mail_user</span>=<span style="color: #800000;">'</span><span style="color: #800000;">xxxxxxx@163.com</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $mail_pass</span>=<span style="color: #800000;">'</span><span style="color: #800000;">Password</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $mail_to</span>=[<span style="color: #800000;">'</span><span style="color: #800000;">949538827@qq.com</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">15521xxxx@139.com</span><span style="color: #800000;">'</span><span style="color: #000000;">];
GetOptions(
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_host=s</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$dead_master_host,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_host=s</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_master_host,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_slave_hosts=s</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_slave_hosts,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">subject=s</span><span style="color: #800000;">'</span>          =&gt;<span style="color: #000000;"> \$subject,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">body=s</span><span style="color: #800000;">'</span>             =&gt;<span style="color: #000000;"> \$body,
);

mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);

sub mailToContacts {
    my ( $smtp, $mail_from, $user, $</span><span style="color: #0000ff;">passwd</span>, $mail_to, $subject, $msg ) =<span style="color: #000000;"> @_;
    open my $DEBUG, </span><span style="color: #800000;">"</span><span style="color: #800000;">&gt; /tmp/monitormail.log</span><span style="color: #800000;">"</span><span style="color: #000000;">
        or die </span><span style="color: #800000;">"</span><span style="color: #800000;">Can't open the debug      file:$!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
    my $sender </span>=<span style="color: #000000;"> new Mail::Sender {
        ctype       </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">text/plain; charset=utf-8</span><span style="color: #800000;">'</span><span style="color: #000000;">,
        encoding    </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">utf-8</span><span style="color: #800000;">'</span><span style="color: #000000;">,
        smtp        </span>=&gt;<span style="color: #000000;"> $smtp,
        from        </span>=&gt;<span style="color: #000000;"> $mail_from,
        auth        </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">LOGIN</span><span style="color: #800000;">'</span><span style="color: #000000;">,
        TLS_allowed </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">0</span><span style="color: #800000;">'</span><span style="color: #000000;">,
        authid      </span>=&gt;<span style="color: #000000;"> $user,
        authpwd     </span>=&gt; $<span style="color: #0000ff;">passwd</span><span style="color: #000000;">,
        to          </span>=&gt;<span style="color: #000000;"> $mail_to,
        subject     </span>=&gt;<span style="color: #000000;"> $subject,
        debug       </span>=&gt;<span style="color: #000000;"> $DEBUG
    };

    $sender</span>-&gt;<span style="color: #000000;">MailMsg(
        {   msg   </span>=&gt;<span style="color: #000000;"> $msg,
            debug </span>=&gt;<span style="color: #000000;"> $DEBUG
        }
    ) or print $Mail::Sender::Error;
    return </span><span style="color: #800080;">1</span><span style="color: #000000;">;
}



# Do whatever you want here

exit </span><span style="color: #800080;">0</span>;</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p>4、在管理节点查看一下配置文件/etc/masterha/app1.cnf可以发现[server1]的内容已经被自动去掉了（server01 192.168.2.131）：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">cat</span> /etc/masterha/<span style="color: #000000;">app1.cnf
[server default]
manager_log</span>=/var/log/masterha/app1/<span style="color: #000000;">manager.log
manager_workdir</span>=/var/log/masterha/<span style="color: #000000;">app1.log
master_binlog_dir</span>=/data/<span style="color: #000000;">mysql
master_ip_failover_script</span>=/usr/local/bin/<span style="color: #000000;">master_ip_failover
master_ip_online_change_script</span>=/usr/local/bin/<span style="color: #000000;">master_ip_online_change
password</span>=<span style="color: #800080;">123456</span><span style="color: #000000;">
ping_interval</span>=<span style="color: #800080;">1</span><span style="color: #000000;">
remote_workdir</span>=/<span style="color: #000000;">tmp
repl_password</span>=<span style="color: #800080;">123456</span><span style="color: #000000;">
repl_user</span>=<span style="color: #000000;">repl
report_script</span>=/usr/local/bin/<span style="color: #000000;">send_report
secondary_check_script</span>=/usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168.<span style="color: #800080;">2.128</span></span> --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
shutdown_script</span>=<span style="color: #800000;">""</span><span style="color: #000000;">
ssh_user</span>=<span style="color: #000000;">root
user</span>=<span style="color: #000000;">root

[server2]
candidate_master</span>=<span style="color: #800080;">1</span><span style="color: #000000;">
check_repl_delay</span>=<span style="color: #800080;">0</span>
<span style="color: #0000ff;">hostname</span>=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span><span style="color: #000000;">

[server3]
</span><span style="color: #0000ff;">hostname</span>=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">
port</span>=<span style="color: #800080;">3306</span></pre>
</div>
<p>&nbsp;</p>
<p>（2）通过脚本的方式管理VIP。这里是修改/usr/local/bin/master_ip_failover，也可以使用其他的语言完成，比如php语言。使用php脚本编写的failover这里就不介绍了。修改完成后内容如下，而且如果使用脚本管理vip的话，需要手动在master服务器上绑定一个vip</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ /sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span> 
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">ifconfig</span><span style="color: #000000;">
eth0      Link encap:Ethernet  HWaddr </span><span style="color: #800080;">00</span>:0C:<span style="color: #800080;">29</span>:<span style="color: #800080;">86</span><span style="color: #000000;">:DC:2A  
          inet addr:</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  Bcast:<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span>  Mask:<span style="color: #800080;">255.255</span>.<span style="color: #800080;">255.0</span><span style="color: #000000;">
          inet6 addr: fe80::20c:29ff:fe86:dc2a</span>/<span style="color: #800080;">64</span><span style="color: #000000;"> Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:</span><span style="color: #800080;">1500</span>  Metric:<span style="color: #800080;">1</span><span style="color: #000000;">
          RX packets:</span><span style="color: #800080;">41643</span> errors:<span style="color: #800080;">0</span> dropped:<span style="color: #800080;">0</span> overruns:<span style="color: #800080;">0</span> frame:<span style="color: #800080;">0</span><span style="color: #000000;">
          TX packets:</span><span style="color: #800080;">24696</span> errors:<span style="color: #800080;">0</span> dropped:<span style="color: #800080;">0</span> overruns:<span style="color: #800080;">0</span> carrier:<span style="color: #800080;">0</span><span style="color: #000000;">
          collisions:</span><span style="color: #800080;">0</span> txqueuelen:<span style="color: #800080;">1000</span><span style="color: #000000;"> 
          RX bytes:</span><span style="color: #800080;">31624443</span> (<span style="color: #800080;">30.1</span> MiB)  TX bytes:<span style="color: #800080;">3388815</span> (<span style="color: #800080;">3.2</span><span style="color: #000000;"> MiB)

eth0:</span><span style="color: #800080;">1</span>    Link encap:Ethernet  HWaddr <span style="color: #800080;">00</span>:0C:<span style="color: #800080;">29</span>:<span style="color: #800080;">86</span><span style="color: #000000;">:DC:2A  
          inet addr:</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>  Bcast:<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span>  Mask:<span style="color: #800080;">255.255</span>.<span style="color: #800080;">255.0</span><span style="color: #000000;">
          UP BROADCAST RUNNING MULTICAST  MTU:</span><span style="color: #800080;">1500</span>  Metric:<span style="color: #800080;">1</span></pre>
</div>
<p>在管理节点（server01 192.168.2.131）修改下/usr/local/bin/master_ip_failover脚本，如下：</p>
<div class="cnblogs_code">
<pre>#!/usr/bin/<span style="color: #0000ff;">env</span> <span style="color: #0000ff;">perl</span><span style="color: #000000;">
use strict;
use warnings FATAL </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">all</span><span style="color: #800000;">'</span><span style="color: #000000;">;

use Getopt::Long;

my (
    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,
    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port
);

my $vip </span>= <span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.88</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $key </span>= <span style="color: #800000;">'</span><span style="color: #800000;">1</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $ssh_start_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/sbin/ifconfig eth1:$key $vip</span><span style="color: #800000;">"</span><span style="color: #000000;">;
my $ssh_stop_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/sbin/ifconfig eth1:$key down</span><span style="color: #800000;">"</span><span style="color: #000000;">;


GetOptions(
    </span><span style="color: #800000;">'</span><span style="color: #800000;">command=s</span><span style="color: #800000;">'</span>          =&gt;<span style="color: #000000;"> \$command,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ssh_user=s</span><span style="color: #800000;">'</span>         =&gt;<span style="color: #000000;"> \$ssh_user,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_host=s</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$orig_master_host,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_ip=s</span><span style="color: #800000;">'</span>   =&gt;<span style="color: #000000;"> \$orig_master_ip,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_port=i</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$orig_master_port,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_host=s</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_master_host,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_ip=s</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$new_master_ip,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_port=i</span><span style="color: #800000;">'</span>  =&gt;<span style="color: #000000;"> \$new_master_port,
);

exit </span>&amp;<span style="color: #000000;">main();

sub main {

    print </span><span style="color: #800000;">"</span><span style="color: #800000;">\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;

    </span><span style="color: #0000ff;">if</span> ( $command eq <span style="color: #800000;">"</span><span style="color: #800000;">stop</span><span style="color: #800000;">"</span> || $command eq <span style="color: #800000;">"</span><span style="color: #800000;">stopssh</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {

        my $exit_code </span>= <span style="color: #800080;">1</span><span style="color: #000000;">;
        eval {
            print </span><span style="color: #800000;">"</span><span style="color: #800000;">Disabling the VIP on old master: $orig_master_host \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            </span>&amp;<span style="color: #000000;">stop_vip();
            $exit_code </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
        };
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
            warn </span><span style="color: #800000;">"</span><span style="color: #800000;">Got Error: $@\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">start</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {

        my $exit_code </span>= <span style="color: #800080;">10</span><span style="color: #000000;">;
        eval {
            print </span><span style="color: #800000;">"</span><span style="color: #800000;">Enabling the VIP - $vip on the new master - $new_master_host \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
            </span>&amp;<span style="color: #000000;">start_vip();
            $exit_code </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
        };
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
            warn $@;
            exit $exit_code;
        }
        exit $exit_code;
    }
    elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">status</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {
        print </span><span style="color: #800000;">"</span><span style="color: #800000;">Checking the Status of the script.. OK \n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
        exit </span><span style="color: #800080;">0</span><span style="color: #000000;">;
    }
    </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        </span>&amp;<span style="color: #000000;">usage();
        exit </span><span style="color: #800080;">1</span><span style="color: #000000;">;
    }
}
sub start_vip() {
    `</span><span style="color: #0000ff;">ssh</span> $ssh_user\@$new_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_start_vip \"`;</span>
<span style="color: #000000;">}
# A simple system call that disable the VIP on the old_master
sub stop_vip() {
    `</span><span style="color: #0000ff;">ssh</span> $ssh_user\@$orig_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_stop_vip \"`;</span>
<span style="color: #000000;">}

sub usage {
    print
    </span><span style="color: #800000;">"</span><span style="color: #800000;">Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
}</span></pre>
</div>
<p>（1）在slave库（192.168.2.129）上停掉slave IO线程，模拟主从延时</p>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span><span style="color: #000000;"> stop slave io_thread;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.03</span> sec)</pre>
</div>
<p>（2）在master库（192.168.2.128）安装sysbench，进行sysbench数据生成，在sbtest库下生成sbtest表，共10W记录</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ <span style="color: #0000ff;">yum</span> <span style="color: #0000ff;">install</span> sysbench -<span style="color: #000000;">y
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ mysql -uroot -p123456 -e <span style="color: #800000;">"</span><span style="color: #800000;">create database sbtest;</span><span style="color: #800000;">"</span>
<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ sysbench --test=oltp --oltp-table-size=<span style="color: #800080;">100000</span> --oltp-read-only=off --init-rng=on --num-threads=<span style="color: #800080;">1</span> --max-requests=<span style="color: #800080;">0</span> --oltp-dist-type=uniform --max-<span style="color: #0000ff;">time</span>=<span style="color: #800080;">1800</span> --mysql-user=root --mysql-socket=/tmp/mysql.sock --mysql-password=<span style="color: #800080;">123456</span> --db-driver=mysql --mysql-table-engine=innodb --oltp-test-mode=complex prepare</pre>
</div>
<p>另外一台slave我们没有停止io线程，所以还在继续接收日志。</p>
<p>（3）在slave库（192.168.2.129）开启slave&nbsp;IO线程：</p>
<div class="cnblogs_code">
<pre>mysql<span style="color: #808080;">&gt;</span><span style="color: #000000;"> start slave io_thread;
Query OK, </span><span style="color: #800000; font-weight: bold;">0</span> rows affected (<span style="color: #800000; font-weight: bold;">0.00</span> sec)</pre>
</div>
<p>（4）停掉master库（192.168.2.128）操作如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800000; font-weight: bold;">192.168</span>.<span style="color: #800000; font-weight: bold;">2.128</span> <span style="color: #ff0000;">[</span><span style="color: #ff0000;">root ~</span><span style="color: #ff0000;">]</span>$ <span style="color: #808080;">/</span>etc<span style="color: #808080;">/</span>init.d<span style="color: #808080;">/</span><span style="color: #000000;">mysqld stop
Shutting down MySQL.... SUCCESS!</span></pre>
</div>
<p>（5）在管理节点查看日志：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ <span style="color: #0000ff;">tail</span> -f /var/log/masterha/app1/manager.log</pre>
</div>
<div class="cnblogs_code" onclick="cnblogs_code_show('402c3014-1f5a-4ead-b1a2-df86c1f05ab1')"><img id="code_img_closed_402c3014-1f5a-4ead-b1a2-df86c1f05ab1" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_402c3014-1f5a-4ead-b1a2-df86c1f05ab1" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('402c3014-1f5a-4ead-b1a2-df86c1f05ab1',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_402c3014-1f5a-4ead-b1a2-df86c1f05ab1" class="cnblogs_code_hide">
<pre>IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===<span style="color: #000000;">

Checking the Status of the script.. OK 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not defined.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set master <span style="color: #0000ff;">ping</span> interval <span style="color: #800080;">1</span><span style="color: #000000;"> seconds.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Set secondary check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting <span style="color: #0000ff;">ping</span> health check on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">48</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Ping(SELECT) succeeded, waiting <span style="color: #0000ff;">until</span> MySQL doesn<span style="color: #800000;">'</span><span style="color: #800000;">t respond..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">38</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL <span style="color: #0000ff;">select</span> <span style="color: #0000ff;">ping</span>: <span style="color: #800080;">2006</span><span style="color: #000000;"> (MySQL server has gone away)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">38</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing SSH check script: save_binary_logs --command=test --start_pos=<span style="color: #800080;">4</span> --binlog_dir=/data/mysql --output_file=/tmp/save_binary_logs_test --manager_version=<span style="color: #800080;">0.53</span> --binlog_prefix=mysql-<span style="color: #000000;">bin
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">38</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing seconary network check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --master_port=<span style="color: #800080;">3306</span>  --user=root  --master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>  --master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">38</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> is reachable.
Monitoring server server03 is reachable, Master is not reachable from server03. OK.
Monitoring server server02 is reachable, Master is not reachable from server02. OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">38</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Master is not reachable from all other monitoring servers. Failover should start.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">1</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">40</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">40</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">2</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning] Got error on MySQL connect: <span style="color: #800080;">2013</span> (Lost connection to MySQL server at <span style="color: #800000;">'</span><span style="color: #800000;">reading initial communication packet</span><span style="color: #800000;">'</span>, system error: <span style="color: #800080;">111</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning] Connection failed <span style="color: #800080;">3</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">(s)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning] Master is not reachable from health checker!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning] Master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) is not reachable!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] SSH is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to a master server failed. Reading configuration <span style="color: #0000ff;">file</span> /etc/masterha_default.cnf and /etc/masterha/<span style="color: #000000;">app1.cnf again, and trying to connect to all servers to check server status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking slave configurations..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  read_only=<span style="color: #800080;">1</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning]  relay_log_purge=<span style="color: #800080;">0</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [warning]  relay_log_purge=<span style="color: #800080;">0</span> is not set on slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking replication filtering settings..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Replication filtering check ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master is down!<span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Terminating monitoring script.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Got exit code <span style="color: #800080;">20</span><span style="color: #000000;"> (Master dead).
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterFailover version <span style="color: #800080;">0.53</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking master reachability via mysql(<span style="color: #0000ff;">double</span><span style="color: #000000;"> check)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Forcing shutdown so that applications never connect to the current master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP deactivatation script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --command=stopssh --ssh_user=<span style="color: #000000;">root  


IN SCRIPT TEST</span>====/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> down==/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span>===<span style="color: #000000;">

Disabling the VIP on old master: </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.1</span><span style="color: #000000;">: Getting Latest Slaves Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The latest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000015</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Latest slaves (Slaves that received relay log files to the latest):
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The oldest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000015</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Oldest slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.2</span>: Saving Dead Master<span style="color: #800000;">'</span><span style="color: #800000;">s Binlog Phase..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Fetching dead master<span style="color: #800000;">'</span><span style="color: #800000;">s binary logs..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">41</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command on the dead master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>): save_binary_logs --command=save --start_file=mysql-bin.<span style="color: #800080;">000015</span>  --start_pos=<span style="color: #800080;">107</span> --binlog_dir=/data/mysql --output_file=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span><span style="color: #000000;">
  Creating </span>/tmp <span style="color: #0000ff;">if</span><span style="color: #000000;"> not exists..    ok.
 Concat binary</span>/relay logs from mysql-bin.<span style="color: #800080;">000015</span> pos <span style="color: #800080;">107</span> to mysql-bin.<span style="color: #800080;">000015</span> EOF into /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118175241.binlog ..
  Dumping binlog format description event, from position </span><span style="color: #800080;">0</span> to <span style="color: #800080;">107</span><span style="color: #000000;">.. ok.
  Dumping effective binlog data from </span>/data/mysql/mysql-bin.<span style="color: #800080;">000015</span> position <span style="color: #800080;">107</span> to <span style="color: #0000ff;">tail</span>(<span style="color: #800080;">126</span><span style="color: #000000;">).. ok.
 Concat succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">42</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog to local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118175241.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">42</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: Determining New Master Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Finding the latest slave that has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovering other slaves..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All slaves received relay logs to the same position. No need to resync each other.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Searching new master from slaves..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Candidate masters from the configuration <span style="color: #0000ff;">file</span><span style="color: #000000;">:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Non-<span style="color: #000000;">candidate masters:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Searching from candidate_master slaves <span style="color: #0000ff;">which</span><span style="color: #000000;"> have received the latest relay log events..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] New master is <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
From:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

To:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> (new master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: New Master Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118175241.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.4</span><span style="color: #000000;">: Master Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] *<span style="color: #000000;">NOTICE: If any error happens from this phase, manual recovery is needed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000015:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log --timestamp=<span style="color: #800080;">20150118175241</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Getting new master<span style="color: #800000;">'</span><span style="color: #800000;">s binlog name and position..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  mysql-bin.<span style="color: #800080;">000005</span>:<span style="color: #800080;">61791</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span><span style="color: #000000;">;
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP activate script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">43</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">  


IN SCRIPT TEST</span>====/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> down==/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span>===<span style="color: #000000;">

Enabling the VIP </span>- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span> on the new master - <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] **<span style="color: #000000;"> Finished master recovery successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4</span><span style="color: #000000;">: Slaves Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.1</span><span style="color: #000000;">: Starting Parallel Slave Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave <span style="color: #0000ff;">diff</span> <span style="color: #0000ff;">file</span> generation on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">20195</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118175241.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) has the latest relay log events.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Generating relay <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.2</span><span style="color: #000000;">: Starting Parallel Slave Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">20197</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118175241.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118175241.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000015:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">44</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log --timestamp=<span style="color: #800080;">20150118175241</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118175241.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All new slave servers recovered successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">5</span><span style="color: #000000;">: New master cleanup phease..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> on the new master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master failover to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Deleted server1 entry from /etc/masterha/<span style="color: #000000;">app1.cnf .
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 

</span>----- Failover Report -----<span style="color: #000000;">

app1: MySQL Master failover </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> succeeded

Master </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> is down!<span style="color: #000000;">

Check MHA Manager logs at localhost.localdomain:</span>/var/log/masterha/app1/manager.log <span style="color: #0000ff;">for</span><span style="color: #000000;"> details.

Started automated(non</span>-<span style="color: #000000;">interactive) failover.
Invalidated master IP address on </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">.
The latest slave </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovery.
Selected </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> as a new master.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Applying all logs succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Activated master IP address.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">: This host has the latest relay log events.
Generating relay </span><span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>: OK: Applying all logs succeeded. Slave started, replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Master failover to </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">17</span>:<span style="color: #800080;">52</span>:<span style="color: #800080;">45</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending mail..
Unknown option: conf</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>（6）在新的Master192.168.2.129上查看数据有没有同步过来，因为在还没创建tbtest库的时候，就停了slave sql线程:</p>
<div class="cnblogs_code">
<pre>mysql&gt;<span style="color: #000000;"> show databases;
</span>+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sbtest             |
| test               |
+--------------------+
<span style="color: #800080;">5</span> rows <span style="color: #0000ff;">in</span> set (<span style="color: #800080;">0.00</span><span style="color: #000000;"> sec)

mysql</span>&gt;<span style="color: #000000;"> use sbtest
Database changed
mysql</span>&gt; <span style="color: #0000ff;">select</span> count(*<span style="color: #000000;">) from sbtest;
</span>+----------+
| count(*) |
+----------+
|   <span style="color: #800080;">100000</span> |
+----------+
<span style="color: #800080;">1</span> row <span style="color: #0000ff;">in</span> set (<span style="color: #800080;">0.03</span><span style="color: #000000;"> sec)

mysql</span>&gt; </pre>
</div>
<p>可以看到落后的数据也同步过来了</p>
<p>&nbsp;</p>
<p>（7）查看来vip的漂移情况：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> [root keepalived-<span style="color: #800080;">1.2</span>.<span style="color: #800080;">12</span>]$ <span style="color: #0000ff;">ifconfig</span><span style="color: #000000;">
eth0      Link encap:Ethernet  HWaddr </span><span style="color: #800080;">00</span>:0C:<span style="color: #800080;">29</span>:<span style="color: #800080;">66</span>:<span style="color: #800080;">95</span>:<span style="color: #800080;">64</span><span style="color: #000000;">  
          inet addr:</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>  Bcast:<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span>  Mask:<span style="color: #800080;">255.255</span>.<span style="color: #800080;">255.0</span><span style="color: #000000;">
          inet6 addr: fe80::20c:29ff:fe66:</span><span style="color: #800080;">9564</span>/<span style="color: #800080;">64</span><span style="color: #000000;"> Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:</span><span style="color: #800080;">1500</span>  Metric:<span style="color: #800080;">1</span><span style="color: #000000;">
          RX packets:</span><span style="color: #800080;">48779</span> errors:<span style="color: #800080;">0</span> dropped:<span style="color: #800080;">0</span> overruns:<span style="color: #800080;">0</span> frame:<span style="color: #800080;">0</span><span style="color: #000000;">
          TX packets:</span><span style="color: #800080;">31696</span> errors:<span style="color: #800080;">0</span> dropped:<span style="color: #800080;">0</span> overruns:<span style="color: #800080;">0</span> carrier:<span style="color: #800080;">0</span><span style="color: #000000;">
          collisions:</span><span style="color: #800080;">0</span> txqueuelen:<span style="color: #800080;">1000</span><span style="color: #000000;"> 
          RX bytes:</span><span style="color: #800080;">46635239</span> (<span style="color: #800080;">44.4</span> MiB)  TX bytes:<span style="color: #800080;">3067487</span> (<span style="color: #800080;">2.9</span><span style="color: #000000;"> MiB)

eth0:</span><span style="color: #800080;">1</span>    Link encap:Ethernet  HWaddr <span style="color: #800080;">00</span>:0C:<span style="color: #800080;">29</span>:<span style="color: #800080;">66</span>:<span style="color: #800080;">95</span>:<span style="color: #800080;">64</span><span style="color: #000000;">  
          inet addr:</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>  Bcast:<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.255</span>  Mask:<span style="color: #800080;">255.255</span>.<span style="color: #800080;">255.0</span><span style="color: #000000;">
          UP BROADCAST RUNNING MULTICAST  MTU:</span><span style="color: #800080;">1500</span>  Metric:<span style="color: #800080;">1</span></pre>
</div>
<p>虚拟IP已经成功漂移到候选的master 192.168.2.129上了</p>
<p>&nbsp;</p>
<p>在做上面通过使用脚本管理vip的实验时，发现很奇怪的事情，就是我查看切换成功后，我去查看再在那台是master库时：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ masterha_check_status --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
app1 is stopped(</span><span style="color: #800080;">2</span><span style="color: #000000;">:NOT_RUNNING).
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ </pre>
</div>
<p>发现<strong>MHA Manager</strong>挂了，这下就呆了，该不会那里配置错了吧，到时真的没想明白后来看了同学的博客得知，官网上对这种情况有解释：</p>
<p><img src="https://images0.cnblogs.com/blog/645933/201501/252057220505723.png" alt="" /></p>
<p>意思是安装一个进程工具，通过该工具结合脚本来管理进程。可以参考官方资料：https://code.google.com/p/mysql-master-ha/wiki/Runnning_Background</p>
<p>&nbsp;</p>
<p><span style="color: #0000ff;">为了不让大家不乱，我再次把实验环境贴出来</span>：</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">角色                  ip地址          主机名          server_id                  类型
Monitor host        </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span>     server01            -<span style="color: #000000;">                   监控复制组
Master              </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>     server02            <span style="color: #800080;">1</span><span style="color: #000000;">                    写入
Candicate master    </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>     server03            <span style="color: #800080;">2</span><span style="color: #000000;">                    读
Slave               </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>     server04            <span style="color: #800080;">3</span>                    读</pre>
</div>
<p>&nbsp;</p>
<p><strong>二.手动Failover（<span style="color: #0000ff;">MHA Manager必须没有运行</span>）</strong></p>
<p><strong>当主服务器故障时，人工手动调用MHA来进行故障切换操作，具体命令如下：</strong></p>
<p>先停MHA Manager:</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$  masterha_stop --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Stopped app1 successfully.
[</span><span style="color: #800080;">1</span>]+  Exit <span style="color: #800080;">1</span>                  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/<span style="color: #0000ff;">null</span> &gt; /var/log/masterha/app1/manager.log <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span>  (wd: /usr/local/<span style="color: #000000;">bin)
(wd now: </span>~<span style="color: #000000;">)
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>在Manager主机上操作如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$  masterha_master_switch --master_state=dead --conf=/etc/masterha/app1.cnf --dead_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --dead_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --<span style="color: #000000;">ignore_last_failover       
</span>--dead_master_ip=&lt;dead_master_ip&gt; is not set. Using <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterFailover version <span style="color: #800080;">0.56</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">18</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/<span style="color: #000000;">MasterFailover.pm, ln181] None of server is dead. Stop failover.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">00</span>:<span style="color: #800080;">42</span>:<span style="color: #800080;">19</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln178] Got ERROR:  at /usr/local/bin/masterha_master_switch line <span style="color: #800080;">53</span></pre>
</div>
<p>看到报错了，报错的原因：<strong>MHA manager检测到没有dead的server，将报错，并结束failover，也就说，我们要手动关了主库，才能正常切换：</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> [root ~]$ /etc/init.d/<span style="color: #000000;">mysqld stop
Shutting down MySQL... SUCCESS</span>! </pre>
</div>
<p>再执行手动failover命令：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ masterha_master_switch --master_state=dead --conf=/etc/masterha/app1.cnf --dead_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --dead_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --ignore_last_failover</pre>
</div>
<div class="cnblogs_code" onclick="cnblogs_code_show('56aaa658-1f4a-427a-93a8-cc2690c6261e')"><img id="code_img_closed_56aaa658-1f4a-427a-93a8-cc2690c6261e" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_56aaa658-1f4a-427a-93a8-cc2690c6261e" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('56aaa658-1f4a-427a-93a8-cc2690c6261e',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_56aaa658-1f4a-427a-93a8-cc2690c6261e" class="cnblogs_code_hide">
<pre>--dead_master_ip=&lt;dead_master_ip&gt; is not set. Using <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configurations from /etc/masterha/<span style="color: #000000;">app1.cnf..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterFailover version <span style="color: #800080;">0.53</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Dead Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking master reachability via mysql(<span style="color: #0000ff;">double</span><span style="color: #000000;"> check)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Servers:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">20</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Master </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> is dead. Proceed? (yes/<span style="color: #000000;">NO): yes
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Forcing shutdown so that applications never connect to the current master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP deactivatation script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --command=stopssh --ssh_user=<span style="color: #000000;">root  


IN SCRIPT TEST</span>====/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> down==/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span>===<span style="color: #000000;">

Disabling the VIP on old master: </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> -<span style="color: #000000;"> [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Dead Master Shutdown Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.1</span><span style="color: #000000;">: Getting Latest Slaves Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The latest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000016</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Latest slaves (Slaves that received relay log files to the latest):
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] The oldest binary log <span style="color: #0000ff;">file</span>/position on all slaves is mysql-bin.<span style="color: #800080;">000016</span>:<span style="color: #800080;">107</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Oldest slaves:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.2</span>: Saving Dead Master<span style="color: #800000;">'</span><span style="color: #800000;">s Binlog Phase..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">24</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">25</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Fetching dead master<span style="color: #800000;">'</span><span style="color: #800000;">s binary logs..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">25</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command on the dead master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>): save_binary_logs --command=save --start_file=mysql-bin.<span style="color: #800080;">000016</span>  --start_pos=<span style="color: #800080;">107</span> --binlog_dir=/data/mysql --output_file=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span><span style="color: #000000;">
  Creating </span>/tmp <span style="color: #0000ff;">if</span><span style="color: #000000;"> not exists..    ok.
 Concat binary</span>/relay logs from mysql-bin.<span style="color: #800080;">000016</span> pos <span style="color: #800080;">107</span> to mysql-bin.<span style="color: #800080;">000016</span> EOF into /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118194920.binlog ..
  Dumping binlog format description event, from position </span><span style="color: #800080;">0</span> to <span style="color: #800080;">107</span><span style="color: #000000;">.. ok.
  Dumping effective binlog data from </span>/data/mysql/mysql-bin.<span style="color: #800080;">000016</span> position <span style="color: #800080;">107</span> to <span style="color: #0000ff;">tail</span>(<span style="color: #800080;">126</span><span style="color: #000000;">).. ok.
 Concat succeeded.
saved_master_binlog_from_192.</span><span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog                                                                    <span style="color: #800080;">100</span>%  <span style="color: #800080;">126</span>     <span style="color: #800080;">0</span>.1KB/s   <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">    
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">25</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog to local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118194920.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">25</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] HealthCheck: SSH to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> is reachable.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: Determining New Master Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Finding the latest slave that has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovering other slaves..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All slaves received relay logs to the same position. No need to resync each other.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> can be new master.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] New master is <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting master failover..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">26</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
From:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;"> (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>
 +--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

To:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> (new master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">

Starting master switch from </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)? (yes/<span style="color: #000000;">NO): yes
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] New master decided manually is <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.3</span><span style="color: #000000;">: New Master Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
saved_master_binlog_from_192.</span><span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog                                                                    <span style="color: #800080;">100</span>%  <span style="color: #800080;">126</span>     <span style="color: #800080;">0</span>.1KB/s   <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">    
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118194920.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3.4</span><span style="color: #000000;">: Master Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] *<span style="color: #000000;">NOTICE: If any error happens from this phase, manual recovery is needed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000016:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">31</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log --timestamp=<span style="color: #800080;">20150118194920</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Getting new master<span style="color: #800000;">'</span><span style="color: #800000;">s binlog name and position..</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  mysql-bin.<span style="color: #800080;">000005</span>:<span style="color: #800080;">61791</span><span style="color: #000000;">
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span><span style="color: #000000;">;
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing master IP activate script:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">  


IN SCRIPT TEST</span>====/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> down==/sbin/<span style="color: #0000ff;">ifconfig</span> eth0:<span style="color: #800080;">1</span> <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span>===<span style="color: #000000;">

Enabling the VIP </span>- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.88</span>/<span style="color: #800080;">24</span> on the new master - <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  OK.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] **<span style="color: #000000;"> Finished master recovery successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">3</span><span style="color: #000000;">: Master Recovery Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4</span><span style="color: #000000;">: Slaves Recovery Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.1</span><span style="color: #000000;">: Starting Parallel Slave Diff Log Generation Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave <span style="color: #0000ff;">diff</span> <span style="color: #0000ff;">file</span> generation on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">20692</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118194920.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  This server has all relay logs. No need to generate <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) has the latest relay log events.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Generating relay <span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">4.2</span><span style="color: #000000;">: Starting Parallel Slave Log Apply Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">20694</span>. Check tmp log /var/log/masterha/app1.log/<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2</span>.130_3306_20150118194920.log <span style="color: #0000ff;">if</span> it takes <span style="color: #0000ff;">time</span><span style="color: #000000;">..
saved_master_binlog_from_192.</span><span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog                                                                    <span style="color: #800080;">100</span>%  <span style="color: #800080;">126</span>     <span style="color: #800080;">0</span>.1KB/s   <span style="color: #800080;">00</span>:<span style="color: #800080;">00</span><span style="color: #000000;">    
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Sending binlog..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">32</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #0000ff;">scp</span> from local:/var/log/masterha/app1.log/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog to root@<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span><span style="color: #000000;">.128_3306_20150118194920.binlog succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Starting recovery on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Generating diffs succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Waiting <span style="color: #0000ff;">until</span><span style="color: #000000;"> all relay logs are applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Getting slave status..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] This slave(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>)<span style="color: #800000;">'</span><span style="color: #800000;">s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000016:107). No need to recover from Exec_Master_Log_Pos.</span>
Sun Jan <span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Connecting to the target slave host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">, running recover script..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span> --slave_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>  --slave_port=<span style="color: #800080;">3306</span> --apply_files=/tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog --workdir=/tmp --target_version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log --timestamp=<span style="color: #800080;">20150118194920</span> --handle_raw_binlog=<span style="color: #800080;">1</span> --disable_log_bin=<span style="color: #800080;">0</span> --manager_version=<span style="color: #800080;">0.53</span> --slave_pass=<span style="color: #000000;">xxx
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Applying differential binary</span>/relay log files /tmp/saved_master_binlog_from_192.<span style="color: #800080;">168.2</span>.128_3306_20150118194920.binlog on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">...
Applying log files succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  All relay logs were successfully applied.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave recovery on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All new slave servers recovered successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">5</span><span style="color: #000000;">: New master cleanup phease..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> on the new master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Master failover to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 

</span>----- Failover Report -----<span style="color: #000000;">

app1: MySQL Master failover </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> succeeded

Master </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> is down!<span style="color: #000000;">

Check MHA Manager logs at localhost.localdomain </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> details.

Started manual(interactive) failover.
Invalidated master IP address on </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span><span style="color: #000000;">.
The latest slave </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) has all relay logs <span style="color: #0000ff;">for</span><span style="color: #000000;"> recovery.
Selected </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> as a new master.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Applying all logs succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">: OK: Activated master IP address.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">: This host has the latest relay log events.
Generating relay </span><span style="color: #0000ff;">diff</span><span style="color: #000000;"> files from the latest slave succeeded.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>: OK: Applying all logs succeeded. Slave started, replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Master failover to </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">19</span>:<span style="color: #800080;">49</span>:<span style="color: #800080;">33</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Sending mail..</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p>
<p>三、<strong>MHA的在线切换</strong></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c57978b4-6152-4545-b60b-d46dcd2a7979')"><img id="code_img_closed_c57978b4-6152-4545-b60b-d46dcd2a7979" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_c57978b4-6152-4545-b60b-d46dcd2a7979" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('c57978b4-6152-4545-b60b-d46dcd2a7979',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_c57978b4-6152-4545-b60b-d46dcd2a7979" class="cnblogs_code_hide">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --orig_master_is_new_slave --running_updates_limit=<span style="color: #800080;">10000</span><span style="color: #000000;"> 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterRotate version <span style="color: #800080;">0.56</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting online master switch..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configuration from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configuration from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] GTID failover mode = <span style="color: #800080;">0</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Current Alive Master: <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>)? (YES/<span style="color: #000000;">no): yes
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking MHA is not monitoring or doing failover..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> can be new master.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
From:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

To:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) (new master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

Starting master switch from </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)? (yes/<span style="color: #000000;">NO): yes
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking whether <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) is ok <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): SHOW SLAVE STATUS returned empty result. To check replication filtering rules, temporarily executing CHANGE MASTER to a dummy host.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): Resetting slave pointing to the dummy host.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Rejecting updates Phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing master ip online change script to disable <span style="color: #0000ff;">write</span><span style="color: #000000;"> on the current master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_online_change --command=stop --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --orig_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --orig_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --new_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --new_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --orig_master_ssh_user=root --new_master_ssh_user=root   --<span style="color: #000000;">orig_master_is_new_slave
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">173112</span><span style="color: #000000;"> Set read_only on the new master.. ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">178943</span><span style="color: #000000;"> Drpping app user on the orig master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">180438</span> Set read_only=<span style="color: #800080;">1</span><span style="color: #000000;"> on the orig master.. ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">183258</span><span style="color: #000000;"> Killing all application threads..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">183387</span> <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Locking all tables on the orig master to reject updates from everybody (including root):
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing FLUSH TABLES WITH READ LOCK..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Orig master binlog:pos is mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Waiting to execute all relay logs on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  master_pos_wait(mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span>) completed on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>). Executed <span style="color: #800080;">0</span><span style="color: #000000;"> events.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Getting new master<span style="color: #800000;">'</span><span style="color: #800000;">s binlog name and position..</span>
Mon Jan <span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  mysql-bin.<span style="color: #800080;">000005</span>:<span style="color: #800080;">61791</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span><span style="color: #000000;">;
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing master ip online change script to allow <span style="color: #0000ff;">write</span><span style="color: #000000;"> on the new master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_online_change --command=start --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --orig_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --orig_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --new_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --new_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --orig_master_ssh_user=root --new_master_ssh_user=root   --<span style="color: #000000;">orig_master_is_new_slave
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">443208</span> Set read_only=<span style="color: #800080;">0</span><span style="color: #000000;"> on the new master.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">444741</span><span style="color: #000000;"> Creating app user on the new master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Switching slaves <span style="color: #0000ff;">in</span><span style="color: #000000;"> parallel..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave switch on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">23040</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Waiting to execute all relay logs on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  master_pos_wait(mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span>) completed on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>). Executed <span style="color: #800080;">0</span><span style="color: #000000;"> events.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave switch on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) succeeded.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Unlocking all tables on the orig master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing UNLOCK TABLES..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting orig master as a new slave..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All new slave servers switched successfully.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">5</span><span style="color: #000000;">: New master cleanup phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Switching master to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ </pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>在许多情况下， 需要将现有的主服务器迁移到另外一台服务器上。 比如主服务器硬件故障，RAID 控制卡需要重建，将主服务器移到性能更好的服务器上等等。维护主服务器引起性能下降， 导致停机时间至少无法写入数据。 另外， 阻塞或杀掉当前运行的会话会导致主主之间数据不一致的问题发生。 MHA 提供快速切换和优雅的阻塞写入，这个切换过程只需要 0.5-2s 的时间，这段时间内数据是无法写入的。在很多情况下，0.5-2s 的阻塞写入是可以接受的。因此切换主服务器不需要计划分配维护时间窗口。</p>
<p><strong>MHA在线切换的大概过程：</strong><br />（1）检测复制设置和确定当前主服务器<br />（2）确定新的主服务器<br />（3）阻塞写入到当前主服务器<br />（4）等待所有从服务器赶上复制<br />（5）授予写入到新的主服务器<br />（6）重新设置从服务器&nbsp;</p>
<p><strong>注意，在线切换的时候应用架构需要考虑以下两个问题：</strong></p>
<p>1.自动识别master和slave的问题（master的机器可能会切换），如果采用了vip的方式，基本可以解决这个问题。</p>
<p>2.负载均衡的问题（可以定义大概的读写比例，每台机器可承担的负载比例，当有机器离开集群时，需要考虑这个问题）</p>
<p><strong>为了保证数据完全一致性，在最快的时间内完成切换，MHA的在线切换必须满足以下条件才会切换成功，否则会切换失败。</strong></p>
<p><strong>(1)所有slave的IO线程都在运行</strong></p>
<p><strong>(2)所有slave的SQL线程都在运行</strong></p>
<p><strong>(3)所有的show slave status的输出中Seconds_Behind_Master参数小于或者等于running_updates_limit秒，如果在切换过程中不指定running_updates_limit,那么默认情况下running_updates_limit为1秒。</strong></p>
<p><strong>(4)在master端，通过show processlist输出，没有一个更新花费的时间大于running_updates_limit秒。</strong></p>
<p>&nbsp;</p>
<p><strong>在线切换步骤如下：</strong></p>
<p>在MHA Manager服务器192.168.2.131上操作，首先，停掉MHA监控：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ masterha_stop --conf=/etc/masterha/<span style="color: #000000;">app1.cnf
Stopped app1 successfully.
[</span><span style="color: #800080;">1</span>]+  Exit <span style="color: #800080;">1</span>                  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/<span style="color: #0000ff;">null</span> &gt; /var/log/masterha/app1/manager.log <span style="color: #800080;">2</span>&gt;&amp;<span style="color: #800080;">1</span>  (wd: /usr/local/<span style="color: #000000;">bin)
(wd now: </span>~<span style="color: #000000;">)
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root ~]$ </pre>
</div>
<p>执行在线切换命令：（<span style="color: #0000ff;">以下是0.53版本的manager和node包报的错</span>）</p>
<div class="cnblogs_code">
<pre>Starting master switch from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)? (yes/<span style="color: #000000;">NO): yes
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking whether <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) is ok <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new master..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): SHOW SLAVE STATUS returned empty result. To check replication filtering rules, temporarily executing CHANGE MASTER to a dummy host.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): Resetting slave pointing to the dummy host.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Rejecting updates Phase..
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing master ip online change script to disable <span style="color: #0000ff;">write</span><span style="color: #000000;"> on the current master:
Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_online_change --command=stop --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span><span style="color: #000000;">  
Got Error: DBI connect(</span><span style="color: #800000;">'</span><span style="color: #800000;">;host=192.168.2.129;port=3306;mysql_connect_timeout=4</span><span style="color: #800000;">'</span>,<span style="color: #800000;">''</span>,...) failed: Access denied <span style="color: #0000ff;">for</span> user <span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span>@<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.131</span><span style="color: #800000;">'</span> (using password: NO) at /usr/local/share/perl5/MHA/DBHelper.pm line <span style="color: #800080;">181</span><span style="color: #000000;">
 at </span>/usr/local/bin/master_ip_online_change line <span style="color: #800080;">138</span><span style="color: #000000;">

Sun Jan </span><span style="color: #800080;">18</span> <span style="color: #800080;">20</span>:<span style="color: #800080;">06</span>:<span style="color: #800080;">17</span> <span style="color: #800080;">2015</span> - [error][/usr/local/share/perl5/MHA/ManagerUtil.pm, ln178] Got ERROR:  at /usr/local/bin/masterha_master_switch line <span style="color: #800080;">53</span></pre>
</div>
<p>原因是脚本<strong>master_ip_<span id="8KSFindDIV" class="KSFIND_CLASS_SELECT">online_change</span></strong><strong>不完整，需要自己进行相应的修改，</strong><strong>脚本中new_master_password这个变量获取不到，导致在线切换失败，所以进行了相关的硬编码，直接把mysql的root用户密码赋值给变量new_master_password，但mha4mysql-manager-0.56和mha4mysql-node-0.56版本已经不需要自己把密码直接赋值了，它自己能读出来，之前版本貌似在读<strong>new_master_password变量时，总获取不到值（perl脚本我也不太懂，需要大家一起来改善，哈哈）</strong></strong></p>
<p>下面来看来0.56版本的执行情况：</p>
<div class="cnblogs_code">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span>  --orig_master_is_new_slave --running_updates_limit=<span style="color: #800080;">10000</span></pre>
</div>
<div class="cnblogs_code" onclick="cnblogs_code_show('ce0f11e7-b1e2-449d-9634-7f639fc326de')"><img id="code_img_closed_ce0f11e7-b1e2-449d-9634-7f639fc326de" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_ce0f11e7-b1e2-449d-9634-7f639fc326de" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('ce0f11e7-b1e2-449d-9634-7f639fc326de',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_ce0f11e7-b1e2-449d-9634-7f639fc326de" class="cnblogs_code_hide">
<pre><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$ masterha_master_switch --conf=/etc/masterha/app1.cnf --master_state=alive --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --orig_master_is_new_slave --running_updates_limit=<span style="color: #800080;">10000</span><span style="color: #000000;"> 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] MHA::MasterRotate version <span style="color: #800080;">0.56</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting online master switch..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [warning] Global configuration <span style="color: #0000ff;">file</span> /etc/<span style="color: #000000;">masterha_default.cnf not found. Skipping.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading application default configuration from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Reading server configuration from /etc/masterha/<span style="color: #000000;">app1.cnf..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] GTID failover mode = <span style="color: #800080;">0</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Current Alive Master: <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Alive Slaves:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">30</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Primary candidate <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new Master (candidate_master is set)
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>)  Version=<span style="color: #800080;">5.5</span>.<span style="color: #800080;">25</span>-log (oldest major version between slaves) log-<span style="color: #000000;">bin:enabled
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">39</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]     Replicating from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>)? (YES/<span style="color: #000000;">no): yes
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take <span style="color: #0000ff;">long</span> <span style="color: #0000ff;">time</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Checking MHA is not monitoring or doing failover..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking replication health on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;">..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span><span style="color: #000000;"> can be new master.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">46</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
From:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) (current master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

To:
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) (new master)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)
 </span>+--<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)

Starting master switch from </span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>)? (yes/<span style="color: #000000;">NO): yes
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Checking whether <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>) is ok <span style="color: #0000ff;">for</span><span style="color: #000000;"> the new master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): SHOW SLAVE STATUS returned empty result. To check replication filtering rules, temporarily executing CHANGE MASTER to a dummy host.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">): Resetting slave pointing to the dummy host.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] ** Phase <span style="color: #800080;">1</span><span style="color: #000000;">: Configuration Check Phase completed.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">2</span><span style="color: #000000;">: Rejecting updates Phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing master ip online change script to disable <span style="color: #0000ff;">write</span><span style="color: #000000;"> on the current master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_online_change --command=stop --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --orig_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --orig_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --new_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --new_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --orig_master_ssh_user=root --new_master_ssh_user=root   --<span style="color: #000000;">orig_master_is_new_slave
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">173112</span><span style="color: #000000;"> Set read_only on the new master.. ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">178943</span><span style="color: #000000;"> Drpping app user on the orig master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">180438</span> Set read_only=<span style="color: #800080;">1</span><span style="color: #000000;"> on the orig master.. ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">183258</span><span style="color: #000000;"> Killing all application threads..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">183387</span> <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Locking all tables on the orig master to reject updates from everybody (including root):
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing FLUSH TABLES WITH READ LOCK..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Orig master binlog:pos is mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Waiting to execute all relay logs on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  master_pos_wait(mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span>) completed on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span>). Executed <span style="color: #800080;">0</span><span style="color: #000000;"> events.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Getting new master<span style="color: #800000;">'</span><span style="color: #800000;">s binlog name and position..</span>
Mon Jan <span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  mysql-bin.<span style="color: #800080;">000005</span>:<span style="color: #800080;">61791</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span><span style="color: #000000;">;
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Executing master ip online change script to allow <span style="color: #0000ff;">write</span><span style="color: #000000;"> on the new master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   /usr/local/bin/master_ip_online_change --command=start --orig_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span> --orig_master_port=<span style="color: #800080;">3306</span> --orig_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --orig_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --new_master_host=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_ip=<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span> --new_master_port=<span style="color: #800080;">3306</span> --new_master_user=<span style="color: #800000;">'</span><span style="color: #800000;">root</span><span style="color: #800000;">'</span> --new_master_password=<span style="color: #800000;">'</span><span style="color: #800000;">123456</span><span style="color: #800000;">'</span> --orig_master_ssh_user=root --new_master_ssh_user=root   --<span style="color: #000000;">orig_master_is_new_slave
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">443208</span> Set read_only=<span style="color: #800080;">0</span><span style="color: #000000;"> on the new master.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> <span style="color: #800080;">444741</span><span style="color: #000000;"> Creating app user on the new master..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Switching slaves <span style="color: #0000ff;">in</span><span style="color: #000000;"> parallel..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave switch on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) started, pid: <span style="color: #800080;">23040</span><span style="color: #000000;">
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Waiting to execute all relay logs on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  master_pos_wait(mysql-bin.<span style="color: #800080;">000017</span>:<span style="color: #800080;">107</span>) completed on <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>). Executed <span style="color: #800080;">0</span><span style="color: #000000;"> events.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]   <span style="color: #0000ff;">done</span><span style="color: #000000;">.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] End of log messages from <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span><span style="color: #000000;"> ...
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] -- Slave switch on host <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.130</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) succeeded.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Unlocking all tables on the orig master:
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Executing UNLOCK TABLES..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  ok.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] Starting orig master as a new slave..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  Resetting slave <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.128</span>:<span style="color: #800080;">3306</span>) and starting replication from the new master <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">)..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Executed CHANGE MASTER.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">]  Slave started.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] All new slave servers switched successfully.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] * Phase <span style="color: #800080;">5</span><span style="color: #000000;">: New master cleanup phase..
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span><span style="color: #000000;">] 
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>]  <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>: Resetting slave <span style="color: #0000ff;">info</span><span style="color: #000000;"> succeeded.
Mon Jan </span><span style="color: #800080;">19</span> <span style="color: #800080;">01</span>:<span style="color: #800080;">51</span>:<span style="color: #800080;">50</span> <span style="color: #800080;">2015</span> - [<span style="color: #0000ff;">info</span>] Switching master to <span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>(<span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.129</span>:<span style="color: #800080;">3306</span><span style="color: #000000;">) completed successfully.
</span><span style="color: #800080;">192.168</span>.<span style="color: #800080;">2.131</span> [root bin]$</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>参数说明：</p>
<div class="cnblogs_code">
<pre>--<span style="color: #000000;">orig_master_is_new_slave 切换时加上此参数是将原 master 变为 slave 节点，如果不加此参数，原来的 master 将不启动

</span>--running_updates_limit=<span style="color: #800080;">10000</span>,故障切换时,候选master 如果有延迟的话， mha 切换不能成功，加上此参数表示延迟在此时间范围内都可切换（单位为s），但是切换的时间长短是由recover 时relay 日志的大小决定 </pre>
</div>
<p><strong>master_ip_<span id="8KSFindDIV" class="KSFIND_CLASS_SELECT">online_change脚本代码如下：</span></strong></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('6080539d-de0e-4b50-b87d-458999316dee')"><img id="code_img_closed_6080539d-de0e-4b50-b87d-458999316dee" class="code_img_closed" src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_6080539d-de0e-4b50-b87d-458999316dee" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('6080539d-de0e-4b50-b87d-458999316dee',event)" src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_6080539d-de0e-4b50-b87d-458999316dee" class="cnblogs_code_hide">
<pre>#!/usr/bin/<span style="color: #0000ff;">env</span> <span style="color: #0000ff;">perl</span><span style="color: #000000;">

#  Copyright (C) </span><span style="color: #800080;">2011</span><span style="color: #000000;"> DeNA Co.,Ltd.
#
#  This program is </span><span style="color: #0000ff;">free</span> software; you can redistribute it and/<span style="color: #000000;">or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version </span><span style="color: #800080;">2</span><span style="color: #000000;"> of the License, or
#  (at your option) any later version.
#
#  This program is distributed </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License </span><span style="color: #0000ff;">for</span> <span style="color: #0000ff;">more</span><span style="color: #000000;"> details.
#
#  You should have received a copy of the GNU General Public License
#   along with this program; </span><span style="color: #0000ff;">if</span> not, <span style="color: #0000ff;">write</span><span style="color: #000000;"> to the Free Software
#  Foundation, Inc.,
#  </span><span style="color: #800080;">51</span> Franklin Street, Fifth Floor, Boston, MA  <span style="color: #800080;">02110</span>-<span style="color: #800080;">1301</span><span style="color: #000000;">  USA

## Note: This is a sample script and is not complete. Modify the script based on your environment.

use strict;
use warnings FATAL </span>=&gt; <span style="color: #800000;">'</span><span style="color: #800000;">all</span><span style="color: #800000;">'</span><span style="color: #000000;">;

use Getopt::Long;
use MHA::DBHelper;
use MHA::NodeUtil;
use Time::HiRes qw( </span><span style="color: #0000ff;">sleep</span><span style="color: #000000;"> gettimeofday tv_interval );
use Data::Dumper;

my $_tstart;
my $_running_interval </span>= <span style="color: #800080;">0.1</span><span style="color: #000000;">;
my (
  $command,              $orig_master_is_new_slave, $orig_master_host,
  $orig_master_ip,       $orig_master_port,         $orig_master_user,
  $orig_master_password, $orig_master_ssh_user,     $new_master_host,
  $new_master_ip,        $new_master_port,          $new_master_user,
  $new_master_password,  $new_master_ssh_user
);
my $vip </span>= <span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.88/24</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $key </span>= <span style="color: #800000;">'</span><span style="color: #800000;">1</span><span style="color: #800000;">'</span><span style="color: #000000;">;
my $ssh_start_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/sbin/ifconfig eth0:$key $vip</span><span style="color: #800000;">"</span><span style="color: #000000;">;
my $ssh_stop_vip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">/sbin/ifconfig eth0:$key down</span><span style="color: #800000;">"</span><span style="color: #000000;">;
my $orig_master_ssh_port </span>= <span style="color: #800080;">22</span><span style="color: #000000;">;
my $new_master_ssh_port </span>= <span style="color: #800080;">22</span><span style="color: #000000;">;
GetOptions(
  </span><span style="color: #800000;">'</span><span style="color: #800000;">command=s</span><span style="color: #800000;">'</span>                =&gt;<span style="color: #000000;"> \$command,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_is_new_slave</span><span style="color: #800000;">'</span> =&gt;<span style="color: #000000;"> \$orig_master_is_new_slave,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_host=s</span><span style="color: #800000;">'</span>       =&gt;<span style="color: #000000;"> \$orig_master_host,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_ip=s</span><span style="color: #800000;">'</span>         =&gt;<span style="color: #000000;"> \$orig_master_ip,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_port=i</span><span style="color: #800000;">'</span>       =&gt;<span style="color: #000000;"> \$orig_master_port,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_user=s</span><span style="color: #800000;">'</span>       =&gt;<span style="color: #000000;"> \$orig_master_user,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_password=s</span><span style="color: #800000;">'</span>   =&gt;<span style="color: #000000;"> \$orig_master_password,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_ssh_user=s</span><span style="color: #800000;">'</span>   =&gt;<span style="color: #000000;"> \$orig_master_ssh_user,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_host=s</span><span style="color: #800000;">'</span>        =&gt;<span style="color: #000000;"> \$new_master_host,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_ip=s</span><span style="color: #800000;">'</span>          =&gt;<span style="color: #000000;"> \$new_master_ip,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_port=i</span><span style="color: #800000;">'</span>        =&gt;<span style="color: #000000;"> \$new_master_port,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_user=s</span><span style="color: #800000;">'</span>        =&gt;<span style="color: #000000;"> \$new_master_user,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_password=s</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$new_master_password,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_ssh_user=s</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$new_master_ssh_user,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">orig_master_ssh_port=i</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$orig_master_ssh_port,
  </span><span style="color: #800000;">'</span><span style="color: #800000;">new_master_ssh_port=i</span><span style="color: #800000;">'</span>    =&gt;<span style="color: #000000;"> \$new_master_ssh_port,
);

exit </span>&amp;<span style="color: #000000;">main();

sub current_time_us {
  my ( $sec, $microsec ) </span>=<span style="color: #000000;"> gettimeofday();
  my $curdate </span>=<span style="color: #000000;"> localtime($sec);
  return $curdate . </span><span style="color: #800000;">"</span> <span style="color: #800000;">"</span> . sprintf( <span style="color: #800000;">"</span><span style="color: #800000;">%06d</span><span style="color: #800000;">"</span><span style="color: #000000;">, $microsec );
}

sub sleep_until {
  my $elapsed </span>=<span style="color: #000000;"> tv_interval($_tstart);
  </span><span style="color: #0000ff;">if</span> ( $_running_interval &gt;<span style="color: #000000;"> $elapsed ) {
    </span><span style="color: #0000ff;">sleep</span>( $_running_interval -<span style="color: #000000;"> $elapsed );
  }
}

sub get_threads_util {
  my $dbh                    </span>= <span style="color: #0000ff;">shift</span><span style="color: #000000;">;
  my $my_connection_id       </span>= <span style="color: #0000ff;">shift</span><span style="color: #000000;">;
  my $running_time_threshold </span>= <span style="color: #0000ff;">shift</span><span style="color: #000000;">;
  my $type                   </span>= <span style="color: #0000ff;">shift</span><span style="color: #000000;">;
  $running_time_threshold </span>= <span style="color: #800080;">0</span><span style="color: #000000;"> unless ($running_time_threshold);
  $type                   </span>= <span style="color: #800080;">0</span><span style="color: #000000;"> unless ($type);
  my @threads;

  my $sth </span>= $dbh-&gt;prepare(<span style="color: #800000;">"</span><span style="color: #800000;">SHOW PROCESSLIST</span><span style="color: #800000;">"</span><span style="color: #000000;">);
  $sth</span>-&gt;<span style="color: #000000;">execute();

  </span><span style="color: #0000ff;">while</span> ( my $ref = $sth-&gt;<span style="color: #000000;">fetchrow_hashref() ) {
    my $</span><span style="color: #0000ff;">id</span>         = $ref-&gt;<span style="color: #000000;">{Id};
    my $user       </span>= $ref-&gt;<span style="color: #000000;">{User};
    my $host       </span>= $ref-&gt;<span style="color: #000000;">{Host};
    my $command    </span>= $ref-&gt;<span style="color: #000000;">{Command};
    my $state      </span>= $ref-&gt;<span style="color: #000000;">{State};
    my $query_time </span>= $ref-&gt;<span style="color: #000000;">{Time};
    my $</span><span style="color: #0000ff;">info</span>       = $ref-&gt;<span style="color: #000000;">{Info};
    $</span><span style="color: #0000ff;">info</span> =~ s/^\s*(.*?)\s*$/$<span style="color: #800080;">1</span>/ <span style="color: #0000ff;">if</span> defined($<span style="color: #0000ff;">info</span><span style="color: #000000;">);
    next </span><span style="color: #0000ff;">if</span> ( $my_connection_id == $<span style="color: #0000ff;">id</span><span style="color: #000000;"> );
    next </span><span style="color: #0000ff;">if</span> ( defined($query_time) &amp;&amp; $query_time &lt;<span style="color: #000000;"> $running_time_threshold );
    next </span><span style="color: #0000ff;">if</span> ( defined($command)    &amp;&amp; $command eq <span style="color: #800000;">"</span><span style="color: #800000;">Binlog Dump</span><span style="color: #800000;">"</span><span style="color: #000000;"> );
    next </span><span style="color: #0000ff;">if</span> ( defined($user)       &amp;&amp; $user eq <span style="color: #800000;">"</span><span style="color: #800000;">system user</span><span style="color: #800000;">"</span><span style="color: #000000;"> );
    next
      </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ( defined($command)
      </span>&amp;&amp; $command eq <span style="color: #800000;">"</span><span style="color: #800000;">Sleep</span><span style="color: #800000;">"</span>
      &amp;&amp;<span style="color: #000000;"> defined($query_time)
      </span>&amp;&amp; $query_time &gt;= <span style="color: #800080;">1</span><span style="color: #000000;"> );

    </span><span style="color: #0000ff;">if</span> ( $type &gt;= <span style="color: #800080;">1</span><span style="color: #000000;"> ) {
      next </span><span style="color: #0000ff;">if</span> ( defined($command) &amp;&amp; $command eq <span style="color: #800000;">"</span><span style="color: #800000;">Sleep</span><span style="color: #800000;">"</span><span style="color: #000000;"> );
      next </span><span style="color: #0000ff;">if</span> ( defined($command) &amp;&amp; $command eq <span style="color: #800000;">"</span><span style="color: #800000;">Connect</span><span style="color: #800000;">"</span><span style="color: #000000;"> );
    }

    </span><span style="color: #0000ff;">if</span> ( $type &gt;= <span style="color: #800080;">2</span><span style="color: #000000;"> ) {
      next </span><span style="color: #0000ff;">if</span> ( defined($<span style="color: #0000ff;">info</span>) &amp;&amp; $<span style="color: #0000ff;">info</span> =~ m/^<span style="color: #0000ff;">select</span>/<span style="color: #000000;">i );
      next </span><span style="color: #0000ff;">if</span> ( defined($<span style="color: #0000ff;">info</span>) &amp;&amp; $<span style="color: #0000ff;">info</span> =~ m/^show/<span style="color: #000000;">i );
    }

    push @threads, $ref;
  }
  return @threads;
}

sub main {
  </span><span style="color: #0000ff;">if</span> ( $command eq <span style="color: #800000;">"</span><span style="color: #800000;">stop</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {
    ## Gracefully killing connections on the current master
    # </span><span style="color: #800080;">1</span>. Set read_only= <span style="color: #800080;">1</span><span style="color: #000000;"> on the new master
    # </span><span style="color: #800080;">2</span><span style="color: #000000;">. DROP USER so that no app user can establish new connections
    # </span><span style="color: #800080;">3</span>. Set read_only= <span style="color: #800080;">1</span><span style="color: #000000;"> on the current master
    # </span><span style="color: #800080;">4</span><span style="color: #000000;">. Kill current queries
    # </span>* Any database access failure will result <span style="color: #0000ff;">in</span><span style="color: #000000;"> script die.
    my $exit_code </span>= <span style="color: #800080;">1</span><span style="color: #000000;">;
    eval {
      ## Setting read_only</span>=<span style="color: #800080;">1</span><span style="color: #000000;"> on the new master (to avoid accident)
      my $new_master_handler </span>=<span style="color: #000000;"> new MHA::DBHelper();

      # args: </span><span style="color: #0000ff;">hostname</span><span style="color: #000000;">, port, user, password, raise_error(die_on_error)_or_not
      $new_master_handler</span>-&gt;<span style="color: #000000;">connect( $new_master_ip, $new_master_port,
        $new_master_user, $new_master_password, </span><span style="color: #800080;">1</span><span style="color: #000000;"> );
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Set read_only on the new master.. </span><span style="color: #800000;">"</span><span style="color: #000000;">;
      $new_master_handler</span>-&gt;<span style="color: #000000;">enable_read_only();
      </span><span style="color: #0000ff;">if</span> ( $new_master_handler-&gt;<span style="color: #000000;">is_read_only() ) {
        print </span><span style="color: #800000;">"</span><span style="color: #800000;">ok.\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        die </span><span style="color: #800000;">"</span><span style="color: #800000;">Failed!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      }
      $new_master_handler</span>-&gt;<span style="color: #000000;">disconnect();

      # Connecting to the orig master, die </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> any database error happens
      my $orig_master_handler </span>=<span style="color: #000000;"> new MHA::DBHelper();
      $orig_master_handler</span>-&gt;<span style="color: #000000;">connect( $orig_master_ip, $orig_master_port,
        $orig_master_user, $orig_master_password, </span><span style="color: #800080;">1</span><span style="color: #000000;"> );

      ## Drop application user so that nobody can connect. Disabling per</span>-<span style="color: #000000;">session binlog beforehand
      $orig_master_handler</span>-&gt;<span style="color: #000000;">disable_log_bin_local();
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Drpping app user on the orig master..\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      #FIXME_xxx_drop_app_user($orig_master_handler);

      ## Waiting </span><span style="color: #0000ff;">for</span> N * <span style="color: #800080;">100</span><span style="color: #000000;"> milliseconds so that current connections can exit
      my $time_until_read_only </span>= <span style="color: #800080;">15</span><span style="color: #000000;">;
      $_tstart </span>=<span style="color: #000000;"> [gettimeofday];
      my @threads </span>= get_threads_util( $orig_master_handler-&gt;<span style="color: #000000;">{dbh},
        $orig_master_handler</span>-&gt;<span style="color: #000000;">{connection_id} );
      </span><span style="color: #0000ff;">while</span> ( $time_until_read_only &gt; <span style="color: #800080;">0</span> &amp;&amp; $#threads &gt;= <span style="color: #800080;">0</span><span style="color: #000000;"> ) {
        </span><span style="color: #0000ff;">if</span> ( $time_until_read_only % <span style="color: #800080;">5</span> == <span style="color: #800080;">0</span><span style="color: #000000;"> ) {
          printf
</span><span style="color: #800000;">"</span><span style="color: #800000;">%s Waiting all running %d threads are disconnected.. (max %d milliseconds)\n</span><span style="color: #800000;">"</span><span style="color: #000000;">,
            current_time_us(), $#threads </span>+ <span style="color: #800080;">1</span>, $time_until_read_only * <span style="color: #800080;">100</span><span style="color: #000000;">;
          </span><span style="color: #0000ff;">if</span> ( $#threads &lt; <span style="color: #800080;">5</span><span style="color: #000000;"> ) {
            print Data::Dumper</span>-&gt;new( [$_] )-&gt;Indent(<span style="color: #800080;">0</span>)-&gt;Terse(<span style="color: #800080;">1</span>)-&gt;Dump . <span style="color: #800000;">"</span><span style="color: #800000;">\n</span><span style="color: #800000;">"</span><span style="color: #000000;">
              foreach (@threads);
          }
        }
        sleep_until();
        $_tstart </span>=<span style="color: #000000;"> [gettimeofday];
        $time_until_read_only</span>--<span style="color: #000000;">;
        @threads </span>= get_threads_util( $orig_master_handler-&gt;<span style="color: #000000;">{dbh},
          $orig_master_handler</span>-&gt;<span style="color: #000000;">{connection_id} );
      }

      ## Setting read_only</span>=<span style="color: #800080;">1</span> on the current master so that nobody(except SUPER) can <span style="color: #0000ff;">write</span><span style="color: #000000;">
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Set read_only=1 on the orig master.. </span><span style="color: #800000;">"</span><span style="color: #000000;">;
      $orig_master_handler</span>-&gt;<span style="color: #000000;">enable_read_only();
      </span><span style="color: #0000ff;">if</span> ( $orig_master_handler-&gt;<span style="color: #000000;">is_read_only() ) {
        print </span><span style="color: #800000;">"</span><span style="color: #800000;">ok.\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      }
      </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        die </span><span style="color: #800000;">"</span><span style="color: #800000;">Failed!\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      }

      ## Waiting </span><span style="color: #0000ff;">for</span> M * <span style="color: #800080;">100</span><span style="color: #000000;"> milliseconds so that current update queries can complete
      my $time_until_kill_threads </span>= <span style="color: #800080;">5</span><span style="color: #000000;">;
      @threads </span>= get_threads_util( $orig_master_handler-&gt;<span style="color: #000000;">{dbh},
        $orig_master_handler</span>-&gt;<span style="color: #000000;">{connection_id} );
      </span><span style="color: #0000ff;">while</span> ( $time_until_kill_threads &gt; <span style="color: #800080;">0</span> &amp;&amp; $#threads &gt;= <span style="color: #800080;">0</span><span style="color: #000000;"> ) {
        </span><span style="color: #0000ff;">if</span> ( $time_until_kill_threads % <span style="color: #800080;">5</span> == <span style="color: #800080;">0</span><span style="color: #000000;"> ) {
          printf
</span><span style="color: #800000;">"</span><span style="color: #800000;">%s Waiting all running %d queries are disconnected.. (max %d milliseconds)\n</span><span style="color: #800000;">"</span><span style="color: #000000;">,
            current_time_us(), $#threads </span>+ <span style="color: #800080;">1</span>, $time_until_kill_threads * <span style="color: #800080;">100</span><span style="color: #000000;">;
          </span><span style="color: #0000ff;">if</span> ( $#threads &lt; <span style="color: #800080;">5</span><span style="color: #000000;"> ) {
            print Data::Dumper</span>-&gt;new( [$_] )-&gt;Indent(<span style="color: #800080;">0</span>)-&gt;Terse(<span style="color: #800080;">1</span>)-&gt;Dump . <span style="color: #800000;">"</span><span style="color: #800000;">\n</span><span style="color: #800000;">"</span><span style="color: #000000;">
              foreach (@threads);
          }
        }
        sleep_until();
        $_tstart </span>=<span style="color: #000000;"> [gettimeofday];
        $time_until_kill_threads</span>--<span style="color: #000000;">;
        @threads </span>= get_threads_util( $orig_master_handler-&gt;<span style="color: #000000;">{dbh},
          $orig_master_handler</span>-&gt;<span style="color: #000000;">{connection_id} );
      }

      ## Terminating all threads
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Killing all application threads..\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      $orig_master_handler</span>-&gt;kill_threads(@threads) <span style="color: #0000ff;">if</span> ( $#threads &gt;= <span style="color: #800080;">0</span><span style="color: #000000;"> );
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> done.\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      $orig_master_handler</span>-&gt;<span style="color: #000000;">enable_log_bin_local();
      $orig_master_handler</span>-&gt;<span style="color: #000000;">disconnect();

      ## After finishing the script, MHA executes FLUSH TABLES WITH READ LOCK
      eval {
      `</span><span style="color: #0000ff;">ssh</span> -p$orig_master_ssh_port $orig_master_ssh_user\@$orig_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_stop_vip \"`;</span>
<span style="color: #000000;">        };
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
            warn $@;
        }
      $exit_code </span>= <span style="color: #800080;">0</span><span style="color: #000000;">;
    };
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
      warn </span><span style="color: #800000;">"</span><span style="color: #800000;">Got Error: $@\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      exit $exit_code;
    }
    exit $exit_code;
  }
  elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">start</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {
    ## Activating master ip on the new master
    # </span><span style="color: #800080;">1</span>. Create app user with <span style="color: #0000ff;">write</span><span style="color: #000000;"> privileges
    # </span><span style="color: #800080;">2</span>. Moving backup script <span style="color: #0000ff;">if</span><span style="color: #000000;"> needed
    # </span><span style="color: #800080;">3</span>. Register new master<span style="color: #800000;">'</span><span style="color: #800000;">s ip to the catalog database</span>
<span style="color: #000000;">
# We don</span><span style="color: #800000;">'</span><span style="color: #800000;">t return error even though activating updatable accounts/ip failed so that we don</span><span style="color: #800000;">'</span>t interrupt slaves<span style="color: #800000;">'</span><span style="color: #800000;"> recovery.</span>
# If exit code is <span style="color: #800080;">0</span> or <span style="color: #800080;">10</span><span style="color: #000000;">, MHA does not abort
    my $exit_code </span>= <span style="color: #800080;">10</span><span style="color: #000000;">;
    eval {
      my $new_master_handler </span>=<span style="color: #000000;"> new MHA::DBHelper();

      # args: </span><span style="color: #0000ff;">hostname</span><span style="color: #000000;">, port, user, password, raise_error_or_not
      $new_master_handler</span>-&gt;<span style="color: #000000;">connect( $new_master_ip, $new_master_port,
        $new_master_user, $new_master_password, </span><span style="color: #800080;">1</span><span style="color: #000000;"> );

      ## Set read_only</span>=<span style="color: #800080;">0</span><span style="color: #000000;"> on the new master
      $new_master_handler</span>-&gt;<span style="color: #000000;">disable_log_bin_local();
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Set read_only=0 on the new master.\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      $new_master_handler</span>-&gt;<span style="color: #000000;">disable_read_only();

      ## Creating an app user on the new master
      print current_time_us() . </span><span style="color: #800000;">"</span><span style="color: #800000;"> Creating app user on the new master..\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      #FIXME_xxx_create_app_user($new_master_handler);
      $new_master_handler</span>-&gt;<span style="color: #000000;">enable_log_bin_local();
      $new_master_handler</span>-&gt;<span style="color: #000000;">disconnect();

      ## Update master ip on the catalog database, etc
      `</span><span style="color: #0000ff;">ssh</span> -p$new_master_ssh_port $new_master_ssh_user\@$new_master_host \<span style="color: #800000;">"</span><span style="color: #800000;"> $ssh_start_vip \"`;</span>
      $exit_code = <span style="color: #800080;">0</span><span style="color: #000000;">;
    };
    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ($@) {
      warn </span><span style="color: #800000;">"</span><span style="color: #800000;">Got Error: $@\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
      exit $exit_code;
    }
    exit $exit_code;
  }
  elsif ( $command eq </span><span style="color: #800000;">"</span><span style="color: #800000;">status</span><span style="color: #800000;">"</span><span style="color: #000000;"> ) {

    # </span><span style="color: #0000ff;">do</span><span style="color: #000000;"> nothing
    exit </span><span style="color: #800080;">0</span><span style="color: #000000;">;
  }
  </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
    </span>&amp;<span style="color: #000000;">usage();
    exit </span><span style="color: #800080;">1</span><span style="color: #000000;">;
  }
}

sub usage {
  print
</span><span style="color: #800000;">"</span><span style="color: #800000;">Usage: master_ip_online_change --command=start|stop|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n</span><span style="color: #800000;">"</span><span style="color: #000000;">;
  die;
}</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>说明可以参考官网：https://code.google.com/p/mysql-master-ha/wiki/Parameters#master_ip_online_change_script（自备梯子）</p>
<p><strong>2、修复宕机的Master&nbsp;</strong></p>
<p><span class="KSFIND_CLASS_SELECT">通常情况下自动切换以后，原master可能已经废弃掉，待原master主机修复后，如果数据完整的情况下，可能想把原来master重新作为新主库的slave，这时我们可以借助当时自动切换时刻的MHA日志来完成对原master的修复。下面是提取相关日志的命令：</span></p>
<p><span class="KSFIND_CLASS_SELECT">从上面信息可以看到：</span></p>
<div class="cnblogs_code">
<pre>All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span style="color: #800000;">'</span><span style="color: #800000;">192.168.2.129</span><span style="color: #800000;">'</span>, MASTER_PORT=<span style="color: #800080;">3306</span>, MASTER_LOG_FILE=<span style="color: #800000;">'</span><span style="color: #800000;">mysql-bin.000005</span><span style="color: #800000;">'</span>, MASTER_LOG_POS=<span style="color: #800080;">61791</span>, MASTER_USER=<span style="color: #800000;">'</span><span style="color: #800000;">repl</span><span style="color: #800000;">'</span>, MASTER_PASSWORD=<span style="color: #800000;">'</span><span style="color: #800000;">xxx</span><span style="color: #800000;">'</span>;</pre>
</div>
<p>意思是说，如果Master主机修复好了，可以在修复好后的Master执行CHANGE MASTER操作，作为新的slave库。</p>
<p>&nbsp;</p>
<p>目前高可用方案可以一定程度上实现数据库的高可用，比如前面文章介绍的<a href="http://www.cnblogs.com/gomysql/p/3671896.html" target="_blank">MMM</a>，<a href="http://www.cnblogs.com/gomysql/p/3674030.html" target="_blank">heartbeat+drbd</a>，<a href="http://www.cnblogs.com/gomysql/p/3664783.html">Cluster</a>等。还有percona的Galera Cluster等。这些高可用软件各有优劣。在进行高可用方案选择时，主要是看业务还有对数据一致性方面的要求。最后出于对数据库的高可用和数据一致性的要求，推荐使用MHA架构。</p>
<p>&nbsp;</p>
<p><strong>总结：</strong></p>
<p><strong>&nbsp;一、尽信书,不如不信，有时按着书本上做某个实验，书上能做出来，但不代表我们按着步骤走也能成功</strong></p>
<p><strong>&nbsp;二、要学会从官网找资料，这样让你懂得更多，因为有时谷歌、百度都找不出相关的资料</strong></p>
<p><strong>&nbsp;三、MHA的实验要多测试，要理解它的切换过程，有很多人搭建完，测试到能转换就完事了，这是远远不够的。</strong></p>
<p><strong>&nbsp;四、MHA环境搭建好后，很多perl脚本是不够完善的，需要自己去修改，很多问题都是perl脚本引起的</strong></p>
<p><strong>&nbsp;五、每个人的搭建环境不一样，遇到的问题可能也不一样，这很正常，只要肯下功夫，终能解决的</strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>参考资料：</p>
<p><a href="https://code.google.com/p/mysql-master-ha/wiki/TableOfContents?tm=6">https://code.google.com/p/mysql-master-ha/wiki/TableOfContents?tm=6</a></p>
<p>http://www.cnblogs.com/gomysql/p/3675429.html（大牛的博客，帮助了我很多）</p>
<p>大部份MHA理论知识参考很赞的书籍《深入浅出MySQL》（第2版）</p>
<p>&nbsp;</p>
<table style="background-color: #b9b9b5; width: 850px; height: 134px;" border="0" cellspacing="5" cellpadding="20" align="left">
<tbody>
<tr>
<td>
<p><span style="font-size: 13px;">作者：陆炫志</span></p>
<p><span style="font-size: 13px;">出处：xuanzhi的博客 <a href="http://www.cnblogs.com/xuanzhi201111" target="_blank">http://www.cnblogs.com/xuanzhi201111</a></span></p>
<p><span style="font-size: 13px;">您的支持是对博主最大的鼓励，感谢您的认真阅读。本文版权归作者所有，欢迎转载，但请保留该声明。</span></p>
</td>
</tr>
</tbody>
</table></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2015-01-26 09:33</span> <a href='https://www.cnblogs.com/xuanzhi201111/'>GoogSQL</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href ="https://i.cnblogs.com/EditPosts.aspx?postid=4231412" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(4231412);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=189848,cb_entryId=4231412,cb_blogApp=currentBlogApp,cb_blogUserGuid='2aadc0ac-22fd-e311-8d02-90b11c0b17d6',cb_entryCreatedDate='2015/1/26 9:33:00';loadViewCount(cb_entryId);var cb_postType=1;</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id='comment_form' class='commentform'>
<a name='commentform'></a>
<div id='divCommentShow'></div>
<div id='comment_nav'><span id='span_refresh_tips'></span><a href='javascript:void(0);' onclick='return RefreshCommentList();' id='lnk_RefreshComments' runat='server' clientidmode='Static'>刷新评论</a><a href='#' onclick='return RefreshPage();'>刷新页面</a><a href='#top'>返回顶部</a></div>
<div id='comment_form_container'></div>
<div class='ad_text_commentbox' id='ad_text_under_commentbox'></div>
<div id='ad_t2'></div>
<div id='opt_under_post'></div>
<script async='async' src='https://www.googletagservices.com/tag/js/gpt.js'></script>
<script>
  var googletag = googletag || {};
  googletag.cmd = googletag.cmd || [];
</script>
<script>
  googletag.cmd.push(function() {
        googletag.defineSlot('/1090369/C1', [300, 250], 'div-gpt-ad-1546353474406-0').addService(googletag.pubads());
        googletag.defineSlot('/1090369/C2', [468, 60], 'div-gpt-ad-1539008685004-0').addService(googletag.pubads());
        googletag.pubads().enableSingleRequest();
        googletag.enableServices();
  });
</script>
<div id='cnblogs_c1' class='c_ad_block'>
<div id='div-gpt-ad-1546353474406-0' style='height:250px; width:300px;'>
<script>
if(canShowAdsense()) {
    googletag.cmd.push(function() { googletag.display('div-gpt-ad-1546353474406-0'); });
}
</script>
</div>
</div>
<div id='under_post_news'></div>
<div id='cnblogs_c2' class='c_ad_block'>
    <div id='div-gpt-ad-1539008685004-0' style='height:60px; width:468px;'>
    <script>
    if(canShowAdsense()) {
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1539008685004-0'); });
    }
    </script>
    </div>
</div>
<div id='under_post_kb'></div>
<div id='HistoryToday' class='c_ad_block'></div>
<script type='text/javascript'>
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2019 GoogSQL
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<!--PageEndHtml Block Begin-->
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;btn=r1.gif&amp;uid=1406887476221493" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!--PageEndHtml Block End-->
</body>
</html>
